{% extends "base.html" %}

{% block title %}Contratos Vencidos - PACTA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/contratos.css') }}">
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="row g-0">
            <!-- Include Header Component with custom content -->
            {% set page_title = "Contratos Vencidos" %}
            {% set page_subtitle = "Gestión de contratos que han expirado" %}
            {% set page_icon = "fas fa-clock" %}
            {% set show_notifications = true %}
            {% set show_user_menu = true %}
            {% include 'components/partials/content_header.html' %}
            
            <!-- Additional Header Actions -->
            <div class="mb-3">
                <a class="btn btn-outline-secondary" href="/contratos">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver a Contratos
                </a>
            </div>
            
            <!-- Alert Section -->
            <div class="alert alert-warning d-flex align-items-center mb-4">
                <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                <div>
                    <strong>Atención:</strong> Los siguientes contratos han vencido y requieren revisión inmediata.
                </div>
            </div>

            <!-- Filters Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Filtros de Búsqueda
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="filterProveedor" class="form-label">Proveedor</label>
                            <select id="filterProveedor" class="form-select">
                                <option value="">Todos los proveedores</option>
                                {% for proveedor in proveedores %}
                                <option value="{{ proveedor.id }}">{{ proveedor.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterCliente" class="form-label">Cliente</label>
                            <select id="filterCliente" class="form-select">
                                <option value="">Todos los clientes</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filterDiasVencido" class="form-label">Días vencido</label>
                            <select id="filterDiasVencido" class="form-select">
                                <option value="">Todos</option>
                                <option value="1-30">1-30 días</option>
                                <option value="31-60">31-60 días</option>
                                <option value="61-90">61-90 días</option>
                                <option value="90+">Más de 90 días</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end gap-2">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="fas fa-search me-1"></i>
                                Buscar
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>
                                Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expired Contracts Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clock text-warning me-2"></i>
                        Contratos Vencidos
                    </h5>
                    <span class="badge bg-warning text-dark" id="expiredCount">{{ contratos_vencidos|length }} contratos vencidos</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="expiredContractsTable">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Proveedor/Cliente</th>
                                    <th>Descripción</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Días Vencido</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contrato in contratos_vencidos %}
                                <tr data-proveedor="{{ contrato.proveedor_id or '' }}" data-cliente="{{ contrato.cliente_id or '' }}" data-dias-vencido="{{ contrato.dias_vencido }}">
                                    <td>
                                        <strong>{{ contrato.numero_contrato }}</strong>
                                    </td>
                                    <td>
                                        {% if contrato.proveedor %}
                                            <div class="entity-info">
                                                <span class="badge badge-info">Proveedor</span>
                                                <div>{{ contrato.proveedor.nombre }}</div>
                                            </div>
                                        {% elif contrato.cliente %}
                                            <div class="entity-info">
                                                <span class="badge badge-success">Cliente</span>
                                                <div>{{ contrato.cliente.nombre }}</div>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="contract-description">
                                            {{ contrato.descripcion[:50] }}{% if contrato.descripcion|length > 50 %}...{% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="date-info">
                                            <strong>{{ contrato.fecha_fin.strftime('%d/%m/%Y') }}</strong>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {% if contrato.dias_vencido <= 30 %}badge-warning{% elif contrato.dias_vencido <= 60 %}badge-danger{% else %}badge-dark{% endif %}">
                                            {{ contrato.dias_vencido }} días
                                        </span>
                                    </td>
                                    <td>
                                        <strong>${{ "{:,.2f}".format(contrato.monto_actual) }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge badge-danger">
                                            <i class="fas fa-exclamation-circle"></i>
                                            Vencido
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons" style="display: flex; gap: 4px;">
                                            <button class="btn btn-sm btn-primary" title="Ver Detalles" onclick="viewContract({{ contrato.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" title="Renovar Contrato" onclick="renewContract({{ contrato.id }})">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                            <button class="btn btn-sm btn-success" title="Crear Suplemento" onclick="createSupplement({{ contrato.id }})">
                                                <i class="fas fa-file-contract"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if not contratos_vencidos %}
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-check-circle fs-1 text-success mb-3"></i>
                        <h3>¡Excelente!</h3>
                        <p>No hay contratos vencidos en este momento.</p>
                        <a class="btn btn-primary" href="/contratos">
                            <i class="fas fa-arrow-left"></i>
                            Volver a Contratos
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            {% if contratos_vencidos %}
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-bolt"></i>
                        Acciones Rápidas
                    </h3>
                </div>
                <div class="card-body">
                    <div class="quick-actions" style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <button class="btn btn-warning" onclick="renewAllExpired()">
                            <i class="fas fa-redo"></i>
                            Renovar Todos
                        </button>
                        <button class="btn btn-info" onclick="exportExpiredContracts()">
                            <i class="fas fa-file-export"></i>
                            Exportar Lista
                        </button>
                        <button class="btn btn-secondary" onclick="sendReminders()">
                            <i class="fas fa-envelope"></i>
                            Enviar Recordatorios
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Include Notifications Modal -->
    {% include 'components/modals/notificaciones/notifications_modal.html' %}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/contract_functions.js') }}"></script>
<script src="{{ url_for('static', filename='js/notification_functions.js') }}"></script>
<script>
    // Expired Contracts specific functions
    function applyFilters() {
        const proveedorFilter = document.getElementById('filterProveedor').value;
        const clienteFilter = document.getElementById('filterCliente').value;
        const diasFilter = document.getElementById('filterDiasVencido').value;
        
        const rows = document.querySelectorAll('#expiredContractsTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            let show = true;
            
            // Filter by proveedor
            if (proveedorFilter && row.dataset.proveedor !== proveedorFilter) {
                show = false;
            }
            
            // Filter by cliente
            if (clienteFilter && row.dataset.cliente !== clienteFilter) {
                show = false;
            }
            
            // Filter by días vencido
            if (diasFilter) {
                const diasVencido = parseInt(row.dataset.diasVencido);
                switch(diasFilter) {
                    case '1-30':
                        if (diasVencido < 1 || diasVencido > 30) show = false;
                        break;
                    case '31-60':
                        if (diasVencido < 31 || diasVencido > 60) show = false;
                        break;
                    case '61-90':
                        if (diasVencido < 61 || diasVencido > 90) show = false;
                        break;
                    case '90+':
                        if (diasVencido <= 90) show = false;
                        break;
                }
            }
            
            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });
        
        document.getElementById('expiredCount').textContent = `${visibleCount} contratos vencidos`;
    }
    
    function clearFilters() {
        document.getElementById('filterProveedor').value = '';
        document.getElementById('filterCliente').value = '';
        document.getElementById('filterDiasVencido').value = '';
        applyFilters();
    }
    
    function viewContract(contractId) {
        // Implementar vista de detalles del contrato
        window.location.href = `/contratos/${contractId}`;
    }
    
    function renewContract(contractId) {
        // Implementar renovación de contrato
        if (confirm('¿Está seguro de que desea renovar este contrato?')) {
            // Lógica de renovación
            console.log('Renovando contrato:', contractId);
        }
    }
    
    function createSupplement(contractId) {
        // Implementar creación de suplemento
        window.location.href = `/suplementos/nuevo?contrato=${contractId}`;
    }
    
    function renewAllExpired() {
        if (confirm('¿Está seguro de que desea renovar todos los contratos vencidos?')) {
            // Lógica para renovar todos
            console.log('Renovando todos los contratos vencidos');
        }
    }
    
    function exportExpiredContracts() {
        // Implementar exportación
        window.location.href = '/api/contratos/vencidos/export';
    }
    
    function sendReminders() {
        if (confirm('¿Desea enviar recordatorios a todos los responsables de contratos vencidos?')) {
            // Lógica para enviar recordatorios
            console.log('Enviando recordatorios');
        }
    }
</script>
{% endblock %}