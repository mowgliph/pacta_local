{% extends "base.html" %}

{% block title %}Dashboard - PACTA{% endblock %}

{% block content %}
    <div class="dashboard-container">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Include Header Component with custom content -->
            {% include 'components/partials/content_header.html' %}
            
            <!-- Main Metrics Cards -->
            <div class="metrics-grid">
                {% set metric_label = 'Total Contratos' %}
                {% set metric_value = estadisticas.total_contratos %}
                {% set metric_icon = 'fas fa-file-contract' %}
                {% set metric_color = 'text-primary' %}
                {% set metric_change = estadisticas.contratos_activos ~ ' activos' %}
                {% set change_type = 'positive' %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = 'Reportes Generados' %}
                {% set metric_value = estadisticas.total_reportes %}
                {% set metric_icon = 'fas fa-chart-bar' %}
                {% set metric_color = 'text-success' %}
                {% set metric_change = estadisticas.reportes_mes ~ ' este mes' %}
                {% set change_type = 'positive' %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = 'Usuarios Activos' %}
                {% set metric_value = estadisticas.usuarios_activos %}
                {% set metric_icon = 'fas fa-users' %}
                {% set metric_color = 'text-warning' %}
                {% set metric_change = estadisticas.sesiones_mes ~ ' sesiones/mes' %}
                {% set change_type = 'positive' %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = 'Valor Total' %}
                {% set metric_value = '$' ~ estadisticas.valor_total %}
                {% set metric_icon = 'fas fa-dollar-sign' %}
                {% set metric_color = 'text-purple' %}
                {% set metric_change = 'En contratos activos' %}
                {% set change_type = 'positive' %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Secondary Metrics Cards -->
            <div class="metrics-grid mt-4">
                {% set metric_label = "Uptime del Sistema" %}
                {% set metric_value = estadisticas.uptime ~ "%" %}
                {% set metric_icon = "fas fa-server" %}
                {% set metric_color = "text-success" %}
                {% set metric_change = "Disponibilidad" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Tiempo de Respuesta" %}
                {% set metric_value = estadisticas.tiempo_respuesta ~ "ms" %}
                {% set metric_icon = "fas fa-tachometer-alt" %}
                {% set metric_color = "text-primary" %}
                {% set metric_change = "Promedio" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Próximos a Vencer" %}
                {% set metric_value = estadisticas.contratos_por_vencer %}
                {% set metric_icon = "fas fa-clock" %}
                {% set metric_color = "text-warning" %}
                {% set metric_change = "Requieren atención" %}
                {% set change_type = "negative" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Reportes Pendientes" %}
                {% set metric_value = estadisticas.reportes_pendientes %}
                {% set metric_icon = "fas fa-exclamation-triangle" %}
                {% set metric_color = "text-danger" %}
                {% set metric_change = "Por procesar" %}
                {% set change_type = "negative" %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Vertical Blocks Layout -->
            <div class="vertical-blocks">
                <!-- Quick Actions Block -->
                <div class="block-section actions-block">
                    <div class="block-header">
                        <h3 class="block-title">Acciones Rápidas</h3>
                        <p class="block-subtitle">Herramientas principales del sistema</p>
                    </div>
                    <div class="block-content">
                        <div class="contract-actions d-flex flex-nowrap gap-3">
                            <button class="btn btn-primary flex-fill d-flex align-items-center gap-2" style="min-width: 150px;" onclick="window.location.href='{{ url_for('contratos.listar') }}'">
                                <i class="fas fa-file-contract"></i>
                                Gestionar Contratos
                            </button>
                            <button class="btn btn-success flex-fill d-flex align-items-center gap-2" style="min-width: 150px;" onclick="window.location.href='{{ url_for('main.reportes') }}'">
                                <i class="fas fa-chart-bar"></i>
                                Ver Reportes
                            </button>
                            <button class="btn btn-warning flex-fill d-flex align-items-center gap-2" style="min-width: 150px;" onclick="window.location.href='{{ url_for('users.usuario') }}'">
                                <i class="fas fa-user"></i>
                                Perfil de Usuario
                            </button>
                            <button class="btn btn-purple flex-fill d-flex align-items-center gap-2" style="min-width: 150px;" onclick="window.location.href='{{ url_for('main.configuracion') }}'">
                                <i class="fas fa-cog"></i>
                                Configuración
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- System Overview Charts Block -->
                <div class="block-section charts-block">
                    <div class="block-header">
                        <h3 class="block-title">Resumen del Sistema</h3>
                        <p class="block-subtitle">Distribución y estado general</p>
                    </div>
                    <div class="block-content">
                        <div class="charts-grid">
                            <div class="donut-chart">
                                <canvas id="contractsOverviewChart" width="120" height="120"></canvas>
                                <div class="donut-value">{{ estadisticas.contratos_activos }}</div>
                                <div class="donut-label">Contratos Activos</div>
                            </div>
                            <div class="donut-chart">
                                <canvas id="reportsOverviewChart" width="120" height="120"></canvas>
                                <div class="donut-value">{{ estadisticas.total_reportes }}</div>
                                <div class="donut-label">Total Reportes</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Contracts Block -->
                <div class="block-section table-block">
                    <div class="block-header">
                        <h3 class="block-title">Contratos Recientes</h3>
                        <p class="block-subtitle">Últimos contratos registrados en el sistema</p>
                    </div>
                    <div class="block-content">
                        <!-- Tabla Consistente de Contratos Recientes -->
                        {% set table_headers = [
                            {'title': 'Contrato', 'sortable': true, 'class': ''},
                            {'title': 'Proveedor', 'sortable': true, 'class': ''},
                            {'title': 'Fecha Vencimiento', 'sortable': true, 'class': ''},
                            {'title': 'Valor', 'sortable': true, 'class': 'text-end'},
                            {'title': 'Estado', 'sortable': true, 'class': 'text-center'}
                        ] %}
                        
                        {% set table_data = [] %}
                        {% for contrato in contratos %}
                            {% set row_data = {
                                'cells': [
                                    {
                                        'value': '<div class="d-flex align-items-center"><i class="fas fa-file-contract text-primary me-2"></i><div><div class="fw-semibold">' + contrato.id|string + '</div><small class="text-muted">' + contrato.tipo|string + '</small></div></div>',
                                        'class': ''
                                    },
                                    {
                                        'value': '<div class="d-flex align-items-center"><img src="https://via.placeholder.com/32x32/3b82f6/ffffff?text=' + contrato.proveedor[0]|string + '" alt="Proveedor" class="rounded-circle me-2" style="width: 32px; height: 32px;"><div><div class="fw-semibold">' + contrato.proveedor|string + '</div></div></div>',
                                        'class': ''
                                    },
                                    {'value': contrato.fecha_vencimiento|string, 'class': ''},
                                    {'value': '<span class="fw-semibold text-success">$' + "{:,}".format(contrato.valor) + '</span>', 'class': 'text-end'},
                                    {
                                        'type': 'badge',
                                        'value': contrato.estado|string,
                                        'variant': 'success' if contrato.estado == 'Activo' else ('warning' if contrato.estado == 'Por Vencer' else 'danger'),
                                        'class': 'text-center'
                                    }
                                ]
                            } %}
                            {% set _ = table_data.append(row_data) %}
                        {% endfor %}
                        
                        {% set empty_message = 'No hay contratos recientes disponibles' %}
                        
                        {% include 'components/partials/consistent_table.html' %}
                        
                        <div class="mt-3 text-center">
                            <a href="/contratos" class="btn btn-primary text-decoration-none">
                                Ver Todos los Contratos
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- System Activity Block -->
                <div class="block-section activity-block">
                    <div class="block-header">
                        <h3 class="block-title">Actividad del Sistema</h3>
                        <p class="block-subtitle">Últimas acciones y eventos importantes</p>
                    </div>
                    <div class="block-content">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div class="activity-item">
                                <div class="activity-dot" style="background: #10b981;"></div>
                                <div class="activity-content">
                                    <div class="activity-title">Sistema actualizado</div>
                                    <div class="activity-subtitle">Versión 2.1.0 instalada correctamente</div>
                                    <div class="activity-time">Hace 1 hora</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-dot" style="background: #3b82f6;"></div>
                                <div class="activity-content">
                                    <div class="activity-title">Nuevo reporte generado</div>
                                    <div class="activity-subtitle">Reporte mensual de contratos completado</div>
                                    <div class="activity-time">Hace 3 horas</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-dot" style="background: #f59e0b;"></div>
                                <div class="activity-content">
                                    <div class="activity-title">Backup programado</div>
                                    <div class="activity-subtitle">Copia de seguridad completada exitosamente</div>
                                    <div class="activity-time">Hace 6 horas</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <div class="activity-dot" style="background: #8b5cf6;"></div>
                                <div class="activity-content">
                                    <div class="activity-title">Usuario conectado</div>
                                    <div class="activity-subtitle">Ana Martínez inició sesión</div>
                                    <div class="activity-time">Hace 8 horas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts específicos del dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard_functions.js') }}"></script>
    <script>
        // Inicializar dashboard cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Validar que las estadísticas existan y sean números válidos
                const estadisticas = {
                    contratos_activos: {{ estadisticas.contratos_activos if estadisticas.contratos_activos is not none else 0 }},
                    contratos_por_vencer: {{ estadisticas.contratos_por_vencer if estadisticas.contratos_por_vencer is not none else 0 }},
                    total_contratos: {{ estadisticas.total_contratos if estadisticas.total_contratos is not none else 0 }},
                    reportes_mes: {{ estadisticas.reportes_mes if estadisticas.reportes_mes is not none else 0 }},
                    total_reportes: {{ estadisticas.total_reportes if estadisticas.total_reportes is not none else 0 }}
                };
                
                // Validar que Chart.js esté cargado
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js no está cargado. Verifique la conexión a CDN.');
                    return;
                }
                
                // Inicializar funciones del dashboard con manejo de errores
                if (window.dashboardFunctions && typeof window.dashboardFunctions.initialize === 'function') {
                    window.dashboardFunctions.initialize(estadisticas);
                } else {
                    console.error('dashboard_functions.js no está cargado correctamente.');
                }
            } catch (error) {
                console.error('Error al inicializar el dashboard:', error);
            }
        });
    </script>
    
    <script src="{{ url_for('static', filename='js/notification_functions.js') }}"></script>
    
    <!-- Include Notifications Modal Component -->
    {% include 'components/modals/notificaciones/notifications_modal.html' %}
{% endblock %}