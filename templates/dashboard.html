{% extends "base.html" %}

{% block title %}Dashboard - PACTA{% endblock %}

{% block content %}
    <div class="dashboard-container">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Include Header Component with custom content -->
            {% include 'components/partials/content_header.html' %}
            
            <!-- Main Metrics Cards -->
            <div class="metrics-grid">
                {% set metric_label = 'Total Contratos' %}
                {% set metric_value = estadisticas.total_contratos %}
                {% set metric_icon = 'fas fa-file-contract' %}
                {% set metric_color = 'text-primary' %}
                {% set metric_change = estadisticas.contratos_activos ~ ' activos' %}
                {% set change_type = 'positive' %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = 'Reportes Generados' %}
                {% set metric_value = estadisticas.total_reportes %}
                {% set metric_icon = 'fas fa-chart-bar' %}
                {% set metric_color = 'text-success' %}
                {% set metric_change = estadisticas.reportes_mes ~ ' este mes' %}
                {% set change_type = 'positive' %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = 'Usuarios Activos' %}
                {% set metric_value = estadisticas.usuarios_activos %}
                {% set metric_icon = 'fas fa-users' %}
                {% set metric_color = 'text-warning' %}
                {% set metric_change = estadisticas.sesiones_mes ~ ' sesiones/mes' %}
                {% set change_type = 'positive' %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = 'Valor Total' %}
                {% set metric_value = '$' ~ estadisticas.valor_total %}
                {% set metric_icon = 'fas fa-dollar-sign' %}
                {% set metric_color = 'text-purple' %}
                {% set metric_change = 'En contratos activos' %}
                {% set change_type = 'positive' %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Secondary Metrics Cards -->
            <div class="metrics-grid mt-4">
                {% set metric_label = "Uptime del Sistema" %}
                {% set metric_value = estadisticas.uptime ~ "%" %}
                {% set metric_icon = "fas fa-server" %}
                {% set metric_color = "text-success" %}
                {% set metric_change = "Disponibilidad" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Tiempo de Respuesta" %}
                {% set metric_value = estadisticas.tiempo_respuesta ~ "ms" %}
                {% set metric_icon = "fas fa-tachometer-alt" %}
                {% set metric_color = "text-primary" %}
                {% set metric_change = "Promedio" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Próximos a Vencer" %}
                {% set metric_value = estadisticas.contratos_por_vencer %}
                {% set metric_icon = "fas fa-clock" %}
                {% set metric_color = "text-warning" %}
                {% set metric_change = "Requieren atención" %}
                {% set change_type = "negative" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Reportes Pendientes" %}
                {% set metric_value = estadisticas.reportes_pendientes %}
                {% set metric_icon = "fas fa-exclamation-triangle" %}
                {% set metric_color = "text-danger" %}
                {% set metric_change = "Por procesar" %}
                {% set change_type = "negative" %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Vertical Blocks Layout -->
            <div class="vertical-blocks">
                <!-- Quick Actions Block -->
                <div class="block-section actions-block">
                    <div class="block-header">
                        <h3 class="block-title">Acciones Rápidas</h3>
                        <p class="block-subtitle">Herramientas principales del sistema</p>
                    </div>
                    <div class="block-content">
                        <div class="contract-actions d-flex flex-nowrap gap-3">
                            <a href="{{ url_for('contratos.listar') }}" class="btn btn-primary flex-fill d-flex align-items-center gap-2 min-w-150">
                                <i class="fas fa-file-contract"></i>
                                Gestionar Contratos
                            </a>
                            <a href="{{ url_for('main.reportes') }}" class="btn btn-success flex-fill d-flex align-items-center gap-2 min-w-150">
                                <i class="fas fa-chart-bar"></i>
                                Ver Reportes
                            </a>
                            <a href="{{ url_for('users.usuario') }}" class="btn btn-warning flex-fill d-flex align-items-center gap-2 min-w-150">
                                <i class="fas fa-user"></i>
                                Perfil de Usuario
                            </a>
                            <a href="{{ url_for('main.configuracion') }}" class="btn btn-purple flex-fill d-flex align-items-center gap-2 min-w-150">
                                <i class="fas fa-cog"></i>
                                Configuración
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- System Overview Charts Block -->
                <div class="block-section charts-block">
                    <div class="block-header">
                        <h3 class="block-title">Resumen del Sistema</h3>
                        <p class="block-subtitle">Distribución y estado general</p>
                    </div>
                    <div class="block-content">
                        <div class="charts-grid">
                            <div class="donut-chart">
                                <canvas id="contractsOverviewChart" width="120" height="120"></canvas>
                                <div class="donut-value">{{ estadisticas.contratos_activos }}</div>
                                <div class="donut-label">Contratos Activos</div>
                            </div>
                            <div class="donut-chart">
                                <canvas id="reportsOverviewChart" width="120" height="120"></canvas>
                                <div class="donut-value">{{ estadisticas.total_reportes }}</div>
                                <div class="donut-label">Total Reportes</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Contracts Block -->
                <div class="block-section table-block">
                    <div class="block-header">
                        <h3 class="block-title">Contratos Recientes</h3>
                        <p class="block-subtitle">Últimos contratos registrados en el sistema</p>
                    </div>
                    <div class="block-content">
                        <!-- Tabla Consistente de Contratos Recientes -->
                        {% set table_headers = [
                            {'title': 'Contrato', 'sortable': true, 'class': ''},
                            {'title': 'Proveedor', 'sortable': true, 'class': ''},
                            {'title': 'Fecha Vencimiento', 'sortable': true, 'class': ''},
                            {'title': 'Valor', 'sortable': true, 'class': 'text-end'},
                            {'title': 'Estado', 'sortable': true, 'class': 'text-center'}
                        ] %}
                        
                        {% set table_data = [] %}
                        {% for contrato in contratos %}
                            {% set row_data = {
                                'cells': [
                                    {
                                        'value': '<div class="d-flex align-items-center"><i class="fas fa-file-contract text-primary me-2"></i><div><div class="fw-semibold">' + contrato.id|string + '</div><small class="text-muted">' + contrato.tipo|string + '</small></div></div>',
                                        'class': ''
                                    },
                                    {
                                        'value': '<div class="d-flex align-items-center"><img src="https://via.placeholder.com/32x32/3b82f6/ffffff?text=' + contrato.proveedor[0]|string + '" alt="Proveedor" class="rounded-circle me-2" style="width: 32px; height: 32px;"><div><div class="fw-semibold">' + contrato.proveedor|string + '</div></div></div>',
                                        'class': ''
                                    },
                                    {'value': contrato.fecha_vencimiento|string, 'class': ''},
                                    {'value': '<span class="fw-semibold text-success">$' + "{:,}".format(contrato.valor) + '</span>', 'class': 'text-end'},
                                    {
                                        'type': 'badge',
                                        'value': contrato.estado|string,
                                        'variant': 'success' if contrato.estado == 'Activo' else ('warning' if contrato.estado == 'Por Vencer' else 'danger'),
                                        'class': 'text-center'
                                    }
                                ]
                            } %}
                            {% set _ = table_data.append(row_data) %}
                        {% endfor %}
                        
                        {% set empty_message = 'No hay contratos recientes disponibles' %}
                        
                        <!-- Tabla de Contratos Recientes -->
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>Contrato</th>
                                        <th>Proveedor</th>
                                        <th>Fecha Vencimiento</th>
                                        <th class="text-end">Valor</th>
                                        <th class="text-center">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for contrato in contratos %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-file-contract text-primary me-2"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ contrato.id }}</div>
                                                    <small class="text-muted">{{ contrato.tipo|default('Sin tipo') }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-sm me-2">
                                                    <span class="avatar-title rounded-circle bg-soft-primary text-primary">
                                                        {{ contrato.proveedor|first|upper }}
                                                    </span>
                                                </div>
                                                <div>{{ contrato.proveedor|default('Sin proveedor') }}</div>
                                            </div>
                                        </td>
                                        <td>{{ contrato.fecha_vencimiento|default('N/A') }}</td>
                                        <td class="text-end">
                                            <span class="fw-semibold text-success">
                                                ${{ "{:,}".format(contrato.valor) if contrato.valor else '0.00' }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            {% if contrato.estado == 'Activo' %}
                                                <span class="badge bg-success">{{ contrato.estado }}</span>
                                            {% elif contrato.estado == 'Por Vencer' %}
                                                <span class="badge bg-warning">{{ contrato.estado }}</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ contrato.estado|default('Inactivo') }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                                <p class="mb-0">No hay contratos recientes disponibles</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <a href="{{ url_for('contratos.listar') }}" class="btn btn-primary">
                                <i class="fas fa-list me-1"></i> Ver Todos los Contratos
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- System Activity Block -->
                <div class="block-section activity-block">
                    <div class="block-header">
                        <h3 class="block-title">Actividad del Sistema</h3>
                        <p class="block-subtitle">Últimas acciones y eventos importantes</p>
                    </div>
                    <div class="block-content">
                        <div>
                            <div class="activity-item">
                                <span class="status-dot status-dot-sm status-color-success"></span>
                                <div class="activity-content">
                                    <div class="activity-message"><strong>Sistema actualizado</strong></div>
                                    <div class="activity-message">Versión 2.1.0 instalada correctamente</div>
                                    <div class="activity-time">Hace 1 hora</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <span class="status-dot status-dot-sm status-color-primary"></span>
                                <div class="activity-content">
                                    <div class="activity-message"><strong>Nuevo reporte generado</strong></div>
                                    <div class="activity-message">Reporte mensual de contratos completado</div>
                                    <div class="activity-time">Hace 3 horas</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <span class="status-dot status-dot-sm status-color-warning"></span>
                                <div class="activity-content">
                                    <div class="activity-message"><strong>Backup programado</strong></div>
                                    <div class="activity-message">Copia de seguridad completada exitosamente</div>
                                    <div class="activity-time">Hace 6 horas</div>
                                </div>
                            </div>
                            <div class="activity-item">
                                <span class="status-dot status-dot-sm status-color-purple"></span>
                                <div class="activity-content">
                                    <div class="activity-message"><strong>Usuario conectado</strong></div>
                                    <div class="activity-message">Ana Martínez inició sesión</div>
                                    <div class="activity-time">Hace 8 horas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts específicos del dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard_functions.js') }}"></script>
    <script>
        // Inicializar dashboard cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Validar que las estadísticas existan y sean números válidos
                const estadisticas = {{ (estadisticas or {}) | tojson }};
                
                // Validar que Chart.js esté cargado
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js no está cargado. Verifique la conexión a CDN.');
                    return;
                }
                
                // Inicializar funciones del dashboard con manejo de errores
                if (window.dashboardFunctions && typeof window.dashboardFunctions.initialize === 'function') {
                    window.dashboardFunctions.initialize(estadisticas);
                } else {
                    console.error('dashboard_functions.js no está cargado correctamente.');
                }
            } catch (error) {
                console.error('Error al inicializar el dashboard:', error);
            }
        });
    </script>
    
    <script src="{{ url_for('static', filename='js/notification_functions.js') }}"></script>
    
    <!-- Include Notifications Modal Component -->
    {% include 'components/modals/notificaciones/notifications_modal.html' %}
{% endblock %}