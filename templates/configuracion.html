{% extends "base.html" %}

{% block title %}Configuración - PACTA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/configuracion.css') }}">
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="row g-0">
            <!-- Include Header Component with custom content -->
            {% set page_title = 'Configuración' %}
            {% set page_subtitle = 'Configuración del sistema y preferencias' %}
            {% set page_icon = 'fas fa-cog' %}
            {% set show_notifications = true %}
            {% set show_user_menu = true %}
            {% include 'components/partials/content_header.html' %}
            
            <!-- Metrics Cards -->
            <div class="row g-3 mb-4">
                <!-- Usuarios Activos -->
                {% set metric_label = "Usuarios Activos" %}
                {% set metric_value = estadisticas.usuarios_activos or 24 %}
                {% set metric_icon = "fas fa-users" %}
                {% set metric_color = "text-primary" %}
                {% set metric_change = "+3 este mes" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                <!-- Último Backup -->
                {% set metric_label = "Último Backup" %}
                {% set metric_value = estadisticas.ultimo_backup or 'Sin backups' %}
                {% set metric_icon = "fas fa-database" %}
                {% set metric_color = "text-warning" %}
                {% set metric_change = estadisticas.ultimo_backup_tipo or 'N/A' %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                <!-- Espacio Usado -->
                {% set metric_label = "Espacio Usado" %}
                {% set metric_value = estadisticas.espacio_usado or '68%' %}
                {% set metric_icon = "fas fa-hdd" %}
                {% set metric_color = "text-purple" %}
                {% set metric_change = "De " + (estadisticas.espacio_total or '500GB') %}
                {% set change_type = "neutral" %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Vertical Blocks Layout -->
            <div class="row g-4">
                <!-- System Tools Block -->
                <div class="col-12 col-lg-6 mb-4">
                    <div class="card h-100">
                    <div class="block-header">
                        <h3 class="block-title">Herramientas del Sistema</h3>
                        <p class="block-subtitle">Utilidades de mantenimiento y administración</p>
                        </div>
                </div>
                    <div class="block-content">
                        <div class="p-4">
                        <div class="d-flex flex-wrap gap-3">
                            <button class="btn btn-purple flex-fill d-flex align-items-center gap-2 min-w-200" data-bs-toggle="modal" data-bs-target="#configModal">
                                <i class="fas fa-cogs"></i>
                                Configuración General
                            </button>
                            <a href="{{ url_for('main.backup') }}" class="btn btn-primary flex-fill d-flex align-items-center gap-2 min-w-200">
                                <i class="fas fa-database"></i>
                                Gestionar Backups
                            </a>
                            <a href="{{ url_for('users.usuarios_lista') }}" class="btn btn-success flex-fill d-flex align-items-center gap-2 min-w-200">
                                <i class="fas fa-users-cog"></i>
                                Gestionar Usuarios
                            </a>
                            <button class="btn btn-warning flex-fill d-flex align-items-center gap-2 min-w-200">
                                <i class="fas fa-shield-alt"></i>
                                Configurar Seguridad
                            </button>

                            </div>
                </div>
                            </div>
                </div>
                        </div>
                </div>
                    </div>
                </div>
                
                <!-- Server Performance Block -->
                <div class="col-12 col-lg-6 mb-4">
                    <div class="card h-100">
                        <div class="block-header">
                            <h3 class="block-title">Rendimiento del Servidor</h3>
                            <p class="block-subtitle">Estadísticas en tiempo real del servidor Pacta</p>
                        </div>
                        <div class="block-content">
                            <!-- Métricas principales del servidor -->
                            <div class="row g-3 mb-4">
                                <div class="col-6 col-md-3">
                                    <div class="server-metric-card">
                                        <div class="server-metric-header">
                                            <i class="fas fa-microchip text-primary"></i>
                                            <span class="server-metric-title">CPU</span>
                                        </div>
                                        <div class="server-metric-value">{{ metricas_servidor.cpu.percent or 0 }}%</div>
                                        <div class="server-metric-details">{{ metricas_servidor.cpu.count or 0 }} núcleos @ {{ metricas_servidor.cpu.frequency or 0 }} MHz</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="server-metric-card">
                                        <div class="server-metric-header">
                                            <i class="fas fa-memory text-success"></i>
                                            <span class="server-metric-title">Memoria RAM</span>
                                        </div>
                                        <div class="server-metric-value">{{ metricas_servidor.memory.percent or 0 }}%</div>
                                        <div class="server-metric-details">{{ metricas_servidor.memory.used_gb or 0 }} GB / {{ metricas_servidor.memory.total_gb or 0 }} GB</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="server-metric-card">
                                        <div class="server-metric-header">
                                            <i class="fas fa-hdd text-warning"></i>
                                            <span class="server-metric-title">Disco</span>
                                        </div>
                                        <div class="server-metric-value">{{ metricas_servidor.disk.percent or 0 }}%</div>
                                        <div class="server-metric-details">{{ metricas_servidor.disk.used_gb or 0 }} GB / {{ metricas_servidor.disk.total_gb or 0 }} GB</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="server-metric-card">
                                        <div class="server-metric-header">
                                            <i class="fas fa-network-wired text-purple"></i>
                                            <span class="server-metric-title">Red</span>
                                        </div>
                                        <div class="server-metric-value">↑{{ metricas_servidor.network.bytes_sent_mb or 0 }} MB</div>
                                        <div class="server-metric-details">↓{{ metricas_servidor.network.bytes_recv_mb or 0 }} MB recibidos</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Información del sistema -->
                            <div class="card card-sm">
                                <div class="card-body">
                                    <h4 class="h6 mb-3">Información del Sistema</h4>
                                    <div class="row g-3 text-small">
                                        <div class="col-6">
                                            <span class="text-muted">Sistema Operativo:</span>
                                            <span class="ms-1 fw-semibold">{{ metricas_servidor.system.platform or 'N/A' }}</span>
                                        </div>
                                        <div class="col-6">
                                            <span class="text-muted">Arquitectura:</span>
                                            <span class="ms-1 fw-semibold">{{ metricas_servidor.system.architecture or 'N/A' }}</span>
                                        </div>
                                        <div class="col-6">
                                            <span class="text-muted">Tiempo Activo:</span>
                                            <span class="ms-1 fw-semibold">{{ metricas_servidor.system.uptime_hours or 0 }} horas</span>
                                        </div>
                                        <div class="col-6">
                                            <span class="text-muted">Procesos:</span>
                                            <span class="ms-1 fw-semibold">{{ metricas_servidor.system.process_count or 0 }}</span>
                                        </div>
                                        <div class="col-6">
                                            <span class="text-muted">Último Reinicio:</span>
                                            <span class="ms-1 fw-semibold">{{ metricas_servidor.system.boot_time or 'N/A' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="system-info-card bg-gradient-primary text-white h-100">
                        <div class="system-info-card-header">
                            <i class="fas fa-server system-info-card-icon"></i>
                            <h4 class="system-info-card-title">Plataforma</h4>
                        </div>
                        <div class="system-info-card-value" id="platform-name">{{ metricas_servidor.system.platform or 'Cargando...' }}</div>
                        <div class="system-info-card-details">
                            <div>Arquitectura: <span id="platform-arch">{{ metricas_servidor.system.architecture or 'N/A' }}</span></div>
                            <div>Procesador: <span id="platform-processor">{{ metricas_servidor.system.processor[:30] + '...' if metricas_servidor.system.processor and metricas_servidor.system.processor|length > 30 else metricas_servidor.system.processor or 'N/A' }}</span></div>
                        </div>
                    </div>
                </div>

                <!-- Application Status Card -->
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="system-info-card bg-gradient-success text-white h-100">
                        <div class="system-info-card-header">
                            <i class="fas fa-rocket system-info-card-icon"></i>
                            <h4 class="system-info-card-title">Estado PACTA</h4>
                        </div>
                        <div class="system-info-card-value" id="app-status">Operativo</div>
                        <div class="system-info-card-details">
                            <div>Versión: <span id="app-version">v2.1.0</span></div>
                            <div>Procesos: <span id="process-count">{{ metricas_servidor.system.process_count or 'N/A' }}</span></div>
                        </div>
                    </div>
                </div>

                <!-- Database Status Card -->
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="system-info-card bg-gradient-danger text-white h-100">
                        <div class="system-info-card-header">
                            <i class="fas fa-database system-info-card-icon"></i>
                            <h4 class="system-info-card-title">Base de Datos</h4>
                        </div>
                        <div class="system-info-card-value" id="db-status">Conectada</div>
                        <div class="system-info-card-details">
                            <div>Tipo: <span id="db-type">SQLite</span></div>
                            <div>Último Backup: <span id="last-backup">{{ estadisticas.ultimo_backup or 'N/A' }}</span></div>
                        </div>
                    </div>
                </div>

                <!-- System Uptime Card -->
                <div class="col-12 col-md-6 col-lg-3">
                    <div class="system-info-card bg-gradient-info text-dark h-100">
                        <div class="system-info-card-header">
                            <i class="fas fa-clock system-info-card-icon text-dark-icon"></i>
                            <h4 class="system-info-card-title text-dark-title">Tiempo Activo</h4>
                        </div>
                        <div class="system-info-card-value text-dark-value" id="system-uptime">{{ '%.1f'|format(metricas_servidor.system.uptime_hours or 0) }}h</div>
                        <div class="system-info-card-details text-dark-details">
                            <div>Inicio: <span id="boot-time">{{ metricas_servidor.system.boot_time or 'N/A' }}</span></div>
                            <div>Estado: <span id="system-health" class="system-health-healthy">Saludable</span></div>
                        </div>
                    </div>
                </div>

                <!-- Version History Card -->
                <div class="col-md-6 col-lg-3 mb-4">
                    <div class="system-info-card bg-gradient-purple">
                        <div class="system-info-card-header">
                            <i class="fas fa-history system-info-card-icon"></i>
                            <h5 class="system-info-card-title">Historial de Versiones</h5>
                        </div>
                        <div class="system-info-card-value">v{{ system_info.version }}</div>
                        <p class="system-info-card-details">Última actualización: {{ system_info.last_update }}</p>
                        <a href="#" class="system-info-card-link" data-bs-toggle="modal" data-bs-target="#versionHistoryModal">
                            <span class="system-info-card-link-text">Ver detalles <i class="fas fa-arrow-right"></i></span>
                        </a>
                    </div>
                </div>
                </div>
                <!-- Bloque de Herramientas del Sistema -->
                <div class="col-12 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Herramientas del Sistema</h5>
                        </div>
                        <div class="card-body">
                            <div class="system-tools-grid">
                                <a href="#" class="system-tool-button btn-primary">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>Reiniciar Servicios</span>
                                </a>
                                <a href="#" class="system-tool-button btn-info">
                                    <i class="fas fa-cogs"></i>
                                    <span>Configuración Avanzada</span>
                                </a>
                                <a href="#" class="system-tool-button btn-warning">
                                    <i class="fas fa-database"></i>
                                    <span>Optimizar Base de Datos</span>
                                </a>
                                <a href="#" class="system-tool-button btn-danger">
                                    <i class="fas fa-power-off"></i>
                                    <span>Apagar Sistema</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Bloque de Rendimiento del Servidor -->
                <div class="col-12 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Rendimiento del Servidor</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6 col-lg-3">
                                    <div class="server-metric-card">
                                        <div class="server-metric-header">
                                            <i class="fas fa-microchip"></i>
                                            <h6 class="server-metric-title">Uso de CPU</h6>
                                        </div>
                                        <div class="server-metric-value">{{ server_performance.cpu_usage }}%</div>
                                        <p class="server-metric-details">Carga promedio: {{ server_performance.cpu_load_avg }}</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="server-metric-card">
                                        <div class="server-metric-header">
                                            <i class="fas fa-memory"></i>
                                            <h6 class="server-metric-title">Uso de RAM</h6>
                                        </div>
                                        <div class="server-metric-value">{{ server_performance.ram_usage }}%</div>
                                        <p class="server-metric-details">Total: {{ server_performance.ram_total }}GB</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="server-metric-card">
                                        <div class="server-metric-header">
                                            <i class="fas fa-hdd"></i>
                                            <h6 class="server-metric-title">Uso de Disco</h6>
                                        </div>
                                        <div class="server-metric-value">{{ server_performance.disk_usage }}%</div>
                                        <p class="server-metric-details">Libre: {{ server_performance.disk_free }}GB</p>
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-3">
                                    <div class="server-metric-card">
                                        <div class="server-metric-header">
                                            <i class="fas fa-network-wired"></i>
                                            <h6 class="server-metric-title">Red</h6>
                                        </div>
                                        <div class="server-metric-value">{{ server_performance.network_traffic }}</div>
                                        <p class="server-metric-details">Latencia: {{ server_performance.network_latency }}ms</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Inicialización de métricas del servidor
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystemInfoUpdates();
        });

        // System Information Dynamic Updates
        function initializeSystemInfoUpdates() {
            // Update system info every 30 seconds
            setInterval(updateSystemInfo, 30000);
            
            // Initial update
            updateSystemInfo();
        }

        function updateSystemInfo() {
            fetch('/api/system-metrics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSystemCards(data.metrics);
                        updateSystemHealth(data.metrics);
                    }
                })
                .catch(error => {
                    console.error('Error updating system info:', error);
                    updateConnectionStatus(false);
                });
        }

        function updateSystemCards(metrics) {
            // Update Platform Info
            const platformName = document.getElementById('platform-name');
            const platformArch = document.getElementById('platform-arch');
            const platformProcessor = document.getElementById('platform-processor');
            
            if (platformName && metrics.system) {
                platformName.textContent = metrics.system.platform || 'N/A';
            }
            if (platformArch && metrics.system) {
                platformArch.textContent = metrics.system.architecture || 'N/A';
            }
            if (platformProcessor && metrics.system) {
                const processor = metrics.system.processor || 'N/A';
                platformProcessor.textContent = processor.length > 30 ? processor.substring(0, 30) + '...' : processor;
            }

            // Update Process Count
            const processCount = document.getElementById('process-count');
            if (processCount && metrics.system) {
                processCount.textContent = metrics.system.process_count || 'N/A';
            }

            // Update System Uptime
            const systemUptime = document.getElementById('system-uptime');
            const bootTime = document.getElementById('boot-time');
            if (systemUptime && metrics.system) {
                const uptime = metrics.system.uptime_hours || 0;
                systemUptime.textContent = uptime.toFixed(1) + 'h';
            }
            if (bootTime && metrics.system) {
                bootTime.textContent = metrics.system.boot_time || 'N/A';
            }
        }



        function updateSystemHealth(metrics) {
            const systemHealth = document.getElementById('system-health');
            const appStatus = document.getElementById('app-status');
            const dbStatus = document.getElementById('db-status');

            let appStatusText = 'Desconocido';
            let systemHealthClass = '';

            if (metrics.application_status === 'running') {
                appStatusText = 'En Funcionamiento';
                systemHealthClass = 'system-health-healthy';
            } else if (metrics.application_status === 'degraded') {
                appStatusText = 'Rendimiento Degradado';
                systemHealthClass = 'system-health-moderate';
            } else if (metrics.application_status === 'stopped') {
                appStatusText = 'Detenida';
                systemHealthClass = 'system-health-overloaded';
            }

            if (systemHealth) {
                systemHealth.textContent = appStatusText;
                systemHealth.classList.remove('system-health-healthy', 'system-health-moderate', 'system-health-overloaded', 'system-health-disconnected');
                systemHealth.classList.add(systemHealthClass);
            }
            
            if (appStatus) {
                appStatus.textContent = appStatusText;
            }
            
            // Update database status (assume connected if we got metrics)
            if (dbStatus) {
                dbStatus.textContent = 'Conectada';
            }
        }

        function updateConnectionStatus(isConnected) {
            if (!isConnected) {
                if (systemHealth) {
                    systemHealth.textContent = 'Sin Conexión';
                    systemHealth.classList.remove('system-health-healthy', 'system-health-moderate', 'system-health-overloaded');
                    systemHealth.classList.add('system-health-disconnected');
                }
                if (appStatus) {
                    appStatus.textContent = 'Desconectado';
                }
                if (dbStatus) {
                    dbStatus.textContent = 'Sin Conexión';
                }
            }
        }

        // Add visual feedback for real-time updates
        function addUpdateIndicator() {
            const indicators = document.querySelectorAll('[id$="-status"], [id$="-uptime"], [id$="-count"]');
            indicators.forEach(indicator => {
                indicator.classList.add('updating');
                setTimeout(() => {
                    indicator.classList.remove('updating');
                }, 300);
            });
        }
    </script>
    
    <!-- Funciones de notificaciones -->
    <script src="{{ url_for('static', filename='js/notification_functions.js') }}"></script>
    
    <!-- Include Notifications Modal Component -->
    {% include 'components/modals/notificaciones/notifications_modal.html' %}
    
    <!-- Include Configuration Modal Component -->
    {% include 'components/modals/configuracion/config_modal.html' %}
{% endblock %}