{% extends "base.html" %}

{% block title %}Configuración - PACTA{% endblock %}

{% block content %}
    <div class="dashboard-container">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Include Header Component with custom content -->
            <div class="content-header">
                <div>
                    <h1 class="page-title">Configuración</h1>
                    <p class="page-subtitle">Configuración del sistema y preferencias</p>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" onclick="openConfigModal()" title="Configuración General">
                        <i class="fas fa-cogs"></i>
                    </button>
                    <button class="btn-icon" id="notifications-bell" title="Notificaciones" onclick="openNotificationsModal()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                    <div class="user-menu">
                        <div class="user-avatar-small avatar-generated">{{ (usuario.nombre or 'Usuario').split()[0][0] }}{{ (usuario.nombre or 'Usuario').split()[1][0] if (usuario.nombre or 'Usuario').split()|length > 1 else (usuario.nombre or 'Usuario').split()[0][1] if (usuario.nombre or 'Usuario').split()[0]|length > 1 else '' }}</div>
                        <span class="user-name-small">{{ usuario.nombre }}</span>
                        <div class="user-dropdown">
                            <a href="{{ url_for('users.usuario') }}" class="dropdown-item">
                <i class="fas fa-user"></i>
                <span>Perfil</span>
            </a>
            <a href="{{ url_for('main.configuracion') }}" class="dropdown-item">
                                <i class="fas fa-cog"></i>
                                <span>Configuración</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metrics Cards -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Usuarios Activos</span>
                        <i class="fas fa-users metric-icon" style="color: #3b82f6;"></i>
                    </div>
                    <div class="metric-value">{{ estadisticas.usuarios_activos or 24 }}</div>
                    <div class="metric-change positive">+3 este mes</div>
                </div>
                

                
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Último Backup</span>
                        <i class="fas fa-database metric-icon" style="color: #f59e0b;"></i>
                    </div>
                    <div class="metric-value">{{ estadisticas.ultimo_backup or 'Sin backups' }}</div>
                    <div class="metric-change positive">{{ estadisticas.ultimo_backup_tipo or 'N/A' }}</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <span class="metric-label">Espacio Usado</span>
                        <i class="fas fa-hdd metric-icon" style="color: #8b5cf6;"></i>
                    </div>
                    <div class="metric-value">{{ estadisticas.espacio_usado or '68%' }}</div>
                    <div class="metric-change neutral">De {{ estadisticas.espacio_total or '500GB' }}</div>
                </div>
            </div>
            
            <!-- Vertical Blocks Layout -->
            <div class="vertical-blocks">
                <!-- System Tools Block -->
                <div class="block-section">
                    <div class="block-header">
                        <h3 class="block-title">Herramientas del Sistema</h3>
                        <p class="block-subtitle">Utilidades de mantenimiento y administración</p>
                    </div>
                    <div class="block-content">
                        <div style="padding: 24px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                            <button class="btn-account" onclick="openConfigModal()" style="flex: 1; min-width: 200px; padding: 12px; background: #667eea; justify-content: flex-start; display: flex; align-items: center; gap: 8px; color: white;">
                                <i class="fas fa-cogs"></i>
                                Configuración General
                            </button>
                            <button class="btn-account" style="flex: 1; min-width: 200px; padding: 12px; background: #3b82f6; justify-content: flex-start; display: flex; align-items: center; gap: 8px; color: white;" onclick="window.location.href='{{ url_for('main.backup') }}'">
                                <i class="fas fa-database"></i>
                                Gestionar Backups
                            </button>
                            <button class="btn-account" style="flex: 1; min-width: 200px; padding: 12px; background: #10b981; justify-content: flex-start; display: flex; align-items: center; gap: 8px; color: white;" onclick="window.location.href='{{ url_for('users.usuarios_lista') }}'">
                                <i class="fas fa-users-cog"></i>
                                Gestionar Usuarios
                            </button>
                            <button class="btn-account" style="flex: 1; min-width: 200px; padding: 12px; background: #f59e0b; justify-content: flex-start; display: flex; align-items: center; gap: 8px; color: white;">
                                <i class="fas fa-shield-alt"></i>
                                Configurar Seguridad
                            </button>

                        </div>
                        </div>
                    </div>
                </div>
                
                <!-- Server Performance Block -->
                <div class="block-section charts-block">
                    <div class="block-header">
                        <h3 class="block-title">Rendimiento del Servidor</h3>
                        <p class="block-subtitle">Estadísticas en tiempo real del servidor Pacta</p>
                    </div>
                    <div class="block-content">
                        <!-- Métricas principales del servidor -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-microchip" style="color: #3b82f6;"></i>
                                    <span style="font-weight: 500; color: #374151;">CPU</span>
                                </div>
                                <div style="font-size: 24px; font-weight: 600; color: #1f2937;">{{ metricas_servidor.cpu.percent or 0 }}%</div>
                                <div style="font-size: 12px; color: #6b7280;">{{ metricas_servidor.cpu.count or 0 }} núcleos @ {{ metricas_servidor.cpu.frequency or 0 }} MHz</div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #10b981;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-memory" style="color: #10b981;"></i>
                                    <span style="font-weight: 500; color: #374151;">Memoria RAM</span>
                                </div>
                                <div style="font-size: 24px; font-weight: 600; color: #1f2937;">{{ metricas_servidor.memory.percent or 0 }}%</div>
                                <div style="font-size: 12px; color: #6b7280;">{{ metricas_servidor.memory.used_gb or 0 }} GB / {{ metricas_servidor.memory.total_gb or 0 }} GB</div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-hdd" style="color: #f59e0b;"></i>
                                    <span style="font-weight: 500; color: #374151;">Disco</span>
                                </div>
                                <div style="font-size: 24px; font-weight: 600; color: #1f2937;">{{ metricas_servidor.disk.percent or 0 }}%</div>
                                <div style="font-size: 12px; color: #6b7280;">{{ metricas_servidor.disk.used_gb or 0 }} GB / {{ metricas_servidor.disk.total_gb or 0 }} GB</div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #8b5cf6;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="fas fa-network-wired" style="color: #8b5cf6;"></i>
                                    <span style="font-weight: 500; color: #374151;">Red</span>
                                </div>
                                <div style="font-size: 16px; font-weight: 600; color: #1f2937;">↑{{ metricas_servidor.network.bytes_sent_mb or 0 }} MB</div>
                                <div style="font-size: 12px; color: #6b7280;">↓{{ metricas_servidor.network.bytes_recv_mb or 0 }} MB recibidos</div>
                            </div>
                        </div>
                        
                        <!-- Información del sistema -->
                        <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-top: 16px;">
                            <h4 style="color: #374151; margin-bottom: 12px; font-size: 14px; font-weight: 600;">Información del Sistema</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 12px;">
                                <div>
                                    <span style="color: #6b7280;">Sistema Operativo:</span>
                                    <span style="color: #374151; font-weight: 500; margin-left: 4px;">{{ metricas_servidor.system.platform or 'N/A' }}</span>
                                </div>
                                <div>
                                    <span style="color: #6b7280;">Arquitectura:</span>
                                    <span style="color: #374151; font-weight: 500; margin-left: 4px;">{{ metricas_servidor.system.architecture or 'N/A' }}</span>
                                </div>
                                <div>
                                    <span style="color: #6b7280;">Tiempo Activo:</span>
                                    <span style="color: #374151; font-weight: 500; margin-left: 4px;">{{ metricas_servidor.system.uptime_hours or 0 }} horas</span>
                                </div>
                                <div>
                                    <span style="color: #6b7280;">Procesos:</span>
                                    <span style="color: #374151; font-weight: 500; margin-left: 4px;">{{ metricas_servidor.system.process_count or 0 }}</span>
                                </div>
                                <div>
                                    <span style="color: #6b7280;">Último Reinicio:</span>
                                    <span style="color: #374151; font-weight: 500; margin-left: 4px;">{{ metricas_servidor.system.boot_time or 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                


                
                <!-- System Information Block -->
                <div class="block-section activity-block">
                    <div class="block-header">
                        <h3 class="block-title">Información del Sistema</h3>
                        <p class="block-subtitle">Detalles técnicos y estado general de PACTA</p>
                    </div>
                    <div class="block-content">
                        <!-- System Info Cards Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
                            
                            <!-- Platform Info Card -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-server" style="font-size: 24px; margin-right: 12px; opacity: 0.9;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Plataforma</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;" id="platform-name">{{ metricas_servidor.system.platform or 'Cargando...' }}</div>
                                <div style="font-size: 14px; opacity: 0.9;">
                                    <div>Arquitectura: <span id="platform-arch">{{ metricas_servidor.system.architecture or 'N/A' }}</span></div>
                                    <div>Procesador: <span id="platform-processor">{{ metricas_servidor.system.processor[:30] + '...' if metricas_servidor.system.processor and metricas_servidor.system.processor|length > 30 else metricas_servidor.system.processor or 'N/A' }}</span></div>
                                </div>
                            </div>

                            <!-- Application Status Card -->
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-rocket" style="font-size: 24px; margin-right: 12px; opacity: 0.9;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Estado PACTA</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #ffffff;" id="app-status">Operativo</div>
                                <div style="font-size: 14px; opacity: 0.9;">
                                    <div>Versión: <span id="app-version">v2.1.0</span></div>
                                    <div>Procesos: <span id="process-count">{{ metricas_servidor.system.process_count or 'N/A' }}</span></div>
                                </div>
                            </div>

                            <!-- Database Status Card -->
                            <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-database" style="font-size: 24px; margin-right: 12px; opacity: 0.9;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Base de Datos</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;" id="db-status">Conectada</div>
                                <div style="font-size: 14px; opacity: 0.9;">
                                    <div>Tipo: <span id="db-type">SQLite</span></div>
                                    <div>Último Backup: <span id="last-backup">{{ estadisticas.ultimo_backup or 'N/A' }}</span></div>
                                </div>
                            </div>

                            <!-- System Uptime Card -->
                            <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 12px; padding: 20px; color: #2d3748; box-shadow: 0 4px 15px rgba(168, 237, 234, 0.3);">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-clock" style="font-size: 24px; margin-right: 12px; color: #4a5568;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #2d3748;">Tiempo Activo</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #2d3748;" id="system-uptime">{{ '%.1f'|format(metricas_servidor.system.uptime_hours or 0) }}h</div>
                                <div style="font-size: 14px; color: #4a5568;">
                                    <div>Inicio: <span id="boot-time">{{ metricas_servidor.system.boot_time or 'N/A' }}</span></div>
                                    <div>Estado: <span id="system-health" style="color: #38a169; font-weight: 600;">Saludable</span></div>
                                </div>
                            </div>

                            <!-- Version History Card -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;" onclick="window.location.href='{{ url_for('changelog.changelog') }}'" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-code-branch" style="font-size: 24px; margin-right: 12px; opacity: 0.9;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Historial de Versiones</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">v2.1.0</div>
                                <div style="font-size: 14px; opacity: 0.9;">
                                    <div>Commits: <span>Ver changelog completo</span></div>
                                    <div style="margin-top: 8px; display: flex; align-items: center; gap: 4px;">
                                        <i class="fas fa-external-link-alt" style="font-size: 12px;"></i>
                                        <span>Hacer clic para ver detalles</span>
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
            

        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Inicialización de métricas del servidor
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystemInfoUpdates();
        });

        // System Information Dynamic Updates
        function initializeSystemInfoUpdates() {
            // Update system info every 30 seconds
            setInterval(updateSystemInfo, 30000);
            
            // Initial update
            updateSystemInfo();
        }

        function updateSystemInfo() {
            fetch('/api/system-metrics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSystemCards(data.metrics);
                        updateSystemHealth(data.metrics);
                    }
                })
                .catch(error => {
                    console.error('Error updating system info:', error);
                    updateConnectionStatus(false);
                });
        }

        function updateSystemCards(metrics) {
            // Update Platform Info
            const platformName = document.getElementById('platform-name');
            const platformArch = document.getElementById('platform-arch');
            const platformProcessor = document.getElementById('platform-processor');
            
            if (platformName && metrics.system) {
                platformName.textContent = metrics.system.platform || 'N/A';
            }
            if (platformArch && metrics.system) {
                platformArch.textContent = metrics.system.architecture || 'N/A';
            }
            if (platformProcessor && metrics.system) {
                const processor = metrics.system.processor || 'N/A';
                platformProcessor.textContent = processor.length > 30 ? processor.substring(0, 30) + '...' : processor;
            }

            // Update Process Count
            const processCount = document.getElementById('process-count');
            if (processCount && metrics.system) {
                processCount.textContent = metrics.system.process_count || 'N/A';
            }

            // Update System Uptime
            const systemUptime = document.getElementById('system-uptime');
            const bootTime = document.getElementById('boot-time');
            if (systemUptime && metrics.system) {
                const uptime = metrics.system.uptime_hours || 0;
                systemUptime.textContent = uptime.toFixed(1) + 'h';
            }
            if (bootTime && metrics.system) {
                bootTime.textContent = metrics.system.boot_time || 'N/A';
            }
        }



        function updateSystemHealth(metrics) {
            const systemHealth = document.getElementById('system-health');
            const appStatus = document.getElementById('app-status');
            const dbStatus = document.getElementById('db-status');
            
            if (metrics && metrics.cpu && metrics.memory) {
                // Determine system health based on CPU and memory usage
                const cpuUsage = metrics.cpu.percent || 0;
                const memoryUsage = metrics.memory.percent || 0;
                
                let healthStatus = 'Saludable';
                let healthColor = '#38a169';
                let appStatusText = 'Operativo';
                
                if (cpuUsage > 80 || memoryUsage > 85) {
                    healthStatus = 'Sobrecargado';
                    healthColor = '#e53e3e';
                    appStatusText = 'Bajo Carga';
                } else if (cpuUsage > 60 || memoryUsage > 70) {
                    healthStatus = 'Moderado';
                    healthColor = '#f59e0b';
                    appStatusText = 'Estable';
                }
                
                if (systemHealth) {
                    systemHealth.textContent = healthStatus;
                    systemHealth.style.color = healthColor;
                }
                
                if (appStatus) {
                    appStatus.textContent = appStatusText;
                }
            }
            
            // Update database status (assume connected if we got metrics)
            if (dbStatus) {
                dbStatus.textContent = 'Conectada';
            }
        }

        function updateConnectionStatus(isConnected) {
            const systemHealth = document.getElementById('system-health');
            const appStatus = document.getElementById('app-status');
            const dbStatus = document.getElementById('db-status');
            
            if (!isConnected) {
                if (systemHealth) {
                    systemHealth.textContent = 'Sin Conexión';
                    systemHealth.style.color = '#e53e3e';
                }
                if (appStatus) {
                    appStatus.textContent = 'Desconectado';
                }
                if (dbStatus) {
                    dbStatus.textContent = 'Sin Conexión';
                }
            }
        }

        // Add visual feedback for real-time updates
        function addUpdateIndicator() {
            const indicators = document.querySelectorAll('[id$="-status"], [id$="-uptime"], [id$="-count"]');
            indicators.forEach(indicator => {
                indicator.style.transition = 'all 0.3s ease';
                indicator.classList.add('updating');
                setTimeout(() => {
                    indicator.classList.remove('updating');
                }, 300);
            });
        }
    </script>
    
    <!-- Funciones de notificaciones -->
    <script src="{{ url_for('static', filename='js/notification_functions.js') }}"></script>
    
    <!-- Include Notifications Modal Component -->
    {% include 'components/modals/notifications_modal.html' %}
    
    <!-- Include Configuration Modal Component -->
    {% include 'components/modals/config_modal.html' %}
    </script>
{% endblock %}