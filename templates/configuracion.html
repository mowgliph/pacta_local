{% extends "base.html" %}

{% block title %}Configuración - PACTA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/configuracion.css') }}">
{% endblock %}

{% block content %}
    <div class="dashboard-container">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Include Header Component with custom content -->
            {% set page_title = 'Configuración' %}
            {% set page_subtitle = 'Configuración del sistema y preferencias' %}
            {% set page_icon = 'fas fa-cog' %}
            {% set show_notifications = true %}
            {% set show_user_menu = true %}
            {% include 'components/partials/content_header.html' %}
            
            <!-- Metrics Cards -->
            <div class="metrics-grid">
                <!-- Usuarios Activos -->
                {% set metric_label = "Usuarios Activos" %}
                {% set metric_value = estadisticas.usuarios_activos or 24 %}
                {% set metric_icon = "fas fa-users" %}
                {% set metric_color = "text-primary" %}
                {% set metric_change = "+3 este mes" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                <!-- Último Backup -->
                {% set metric_label = "Último Backup" %}
                {% set metric_value = estadisticas.ultimo_backup or 'Sin backups' %}
                {% set metric_icon = "fas fa-database" %}
                {% set metric_color = "text-warning" %}
                {% set metric_change = estadisticas.ultimo_backup_tipo or 'N/A' %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                <!-- Espacio Usado -->
                {% set metric_label = "Espacio Usado" %}
                {% set metric_value = estadisticas.espacio_usado or '68%' %}
                {% set metric_icon = "fas fa-hdd" %}
                {% set metric_color = "text-purple" %}
                {% set metric_change = "De " + (estadisticas.espacio_total or '500GB') %}
                {% set change_type = "neutral" %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Vertical Blocks Layout -->
            <div class="vertical-blocks">
                <!-- System Tools Block -->
                <div class="block-section">
                    <div class="block-header">
                        <h3 class="block-title">Herramientas del Sistema</h3>
                        <p class="block-subtitle">Utilidades de mantenimiento y administración</p>
                    </div>
                    <div class="block-content">
                        <div class="p-4">
                        <div class="d-flex flex-wrap gap-3">
                            <button class="btn btn-purple flex-fill d-flex align-items-center gap-2 min-w-200" data-bs-toggle="modal" data-bs-target="#configModal">
                                <i class="fas fa-cogs"></i>
                                Configuración General
                            </button>
                            <a href="{{ url_for('main.backup') }}" class="btn btn-primary flex-fill d-flex align-items-center gap-2 min-w-200">
                                <i class="fas fa-database"></i>
                                Gestionar Backups
                            </a>
                            <a href="{{ url_for('users.usuarios_lista') }}" class="btn btn-success flex-fill d-flex align-items-center gap-2 min-w-200">
                                <i class="fas fa-users-cog"></i>
                                Gestionar Usuarios
                            </a>
                            <button class="btn btn-warning flex-fill d-flex align-items-center gap-2 min-w-200">
                                <i class="fas fa-shield-alt"></i>
                                Configurar Seguridad
                            </button>

                        </div>
                        </div>
                    </div>
                </div>
                
                <!-- Server Performance Block -->
                <div class="block-section charts-block">
                    <div class="block-header">
                        <h3 class="block-title">Rendimiento del Servidor</h3>
                        <p class="block-subtitle">Estadísticas en tiempo real del servidor Pacta</p>
                    </div>
                    <div class="block-content">
                        <!-- Métricas principales del servidor -->
                        <div class="grid grid-cols-4 gap-4 mb-4">
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="fas fa-microchip text-primary"></i>
                                        <span class="fw-semibold">CPU</span>
                                    </div>
                                    <div class="fs-4 fw-bold">{{ metricas_servidor.cpu.percent or 0 }}%</div>
                                    <div class="text-muted text-small">{{ metricas_servidor.cpu.count or 0 }} núcleos @ {{ metricas_servidor.cpu.frequency or 0 }} MHz</div>
                                </div>
                            </div>
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="fas fa-memory text-success"></i>
                                        <span class="fw-semibold">Memoria RAM</span>
                                    </div>
                                    <div class="fs-4 fw-bold">{{ metricas_servidor.memory.percent or 0 }}%</div>
                                    <div class="text-muted text-small">{{ metricas_servidor.memory.used_gb or 0 }} GB / {{ metricas_servidor.memory.total_gb or 0 }} GB</div>
                                </div>
                            </div>
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="fas fa-hdd text-warning"></i>
                                        <span class="fw-semibold">Disco</span>
                                    </div>
                                    <div class="fs-4 fw-bold">{{ metricas_servidor.disk.percent or 0 }}%</div>
                                    <div class="text-muted text-small">{{ metricas_servidor.disk.used_gb or 0 }} GB / {{ metricas_servidor.disk.total_gb or 0 }} GB</div>
                                </div>
                            </div>
                            <div class="card card-sm">
                                <div class="card-body">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="fas fa-network-wired text-purple"></i>
                                        <span class="fw-semibold">Red</span>
                                    </div>
                                    <div class="fw-bold">↑{{ metricas_servidor.network.bytes_sent_mb or 0 }} MB</div>
                                    <div class="text-muted text-small">↓{{ metricas_servidor.network.bytes_recv_mb or 0 }} MB recibidos</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información del sistema -->
                        <div class="card card-sm">
                            <div class="card-body">
                                <h4 class="h6 mb-3">Información del Sistema</h4>
                                <div class="grid grid-cols-4 gap-3 text-small">
                                    <div>
                                        <span class="text-muted">Sistema Operativo:</span>
                                        <span class="ms-1 fw-semibold">{{ metricas_servidor.system.platform or 'N/A' }}</span>
                                    </div>
                                    <div>
                                        <span class="text-muted">Arquitectura:</span>
                                        <span class="ms-1 fw-semibold">{{ metricas_servidor.system.architecture or 'N/A' }}</span>
                                    </div>
                                    <div>
                                        <span class="text-muted">Tiempo Activo:</span>
                                        <span class="ms-1 fw-semibold">{{ metricas_servidor.system.uptime_hours or 0 }} horas</span>
                                    </div>
                                    <div>
                                        <span class="text-muted">Procesos:</span>
                                        <span class="ms-1 fw-semibold">{{ metricas_servidor.system.process_count or 0 }}</span>
                                    </div>
                                    <div>
                                        <span class="text-muted">Último Reinicio:</span>
                                        <span class="ms-1 fw-semibold">{{ metricas_servidor.system.boot_time or 'N/A' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                


                
                <!-- System Information Block -->
                <div class="block-section activity-block">
                    <div class="block-header">
                        <h3 class="block-title">Información del Sistema</h3>
                        <p class="block-subtitle">Detalles técnicos y estado general de PACTA</p>
                    </div>
                    <div class="block-content">
                        <!-- System Info Cards Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px;">
                            
                            <!-- Platform Info Card -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-server" style="font-size: 24px; margin-right: 12px; opacity: 0.9;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Plataforma</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;" id="platform-name">{{ metricas_servidor.system.platform or 'Cargando...' }}</div>
                                <div style="font-size: 14px; opacity: 0.9;">
                                    <div>Arquitectura: <span id="platform-arch">{{ metricas_servidor.system.architecture or 'N/A' }}</span></div>
                                    <div>Procesador: <span id="platform-processor">{{ metricas_servidor.system.processor[:30] + '...' if metricas_servidor.system.processor and metricas_servidor.system.processor|length > 30 else metricas_servidor.system.processor or 'N/A' }}</span></div>
                                </div>
                            </div>

                            <!-- Application Status Card -->
                            <div style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-rocket" style="font-size: 24px; margin-right: 12px; opacity: 0.9;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Estado PACTA</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #ffffff;" id="app-status">Operativo</div>
                                <div style="font-size: 14px; opacity: 0.9;">
                                    <div>Versión: <span id="app-version">v2.1.0</span></div>
                                    <div>Procesos: <span id="process-count">{{ metricas_servidor.system.process_count or 'N/A' }}</span></div>
                                </div>
                            </div>

                            <!-- Database Status Card -->
                            <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-database" style="font-size: 24px; margin-right: 12px; opacity: 0.9;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Base de Datos</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;" id="db-status">Conectada</div>
                                <div style="font-size: 14px; opacity: 0.9;">
                                    <div>Tipo: <span id="db-type">SQLite</span></div>
                                    <div>Último Backup: <span id="last-backup">{{ estadisticas.ultimo_backup or 'N/A' }}</span></div>
                                </div>
                            </div>

                            <!-- System Uptime Card -->
                            <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 12px; padding: 20px; color: #2d3748; box-shadow: 0 4px 15px rgba(168, 237, 234, 0.3);">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-clock" style="font-size: 24px; margin-right: 12px; color: #4a5568;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #2d3748;">Tiempo Activo</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px; color: #2d3748;" id="system-uptime">{{ '%.1f'|format(metricas_servidor.system.uptime_hours or 0) }}h</div>
                                <div style="font-size: 14px; color: #4a5568;">
                                    <div>Inicio: <span id="boot-time">{{ metricas_servidor.system.boot_time or 'N/A' }}</span></div>
                                    <div>Estado: <span id="system-health" style="color: #38a169; font-weight: 600;">Saludable</span></div>
                                </div>
                            </div>

                            <!-- Version History Card -->
                            <a href="{{ url_for('changelog.changelog') }}" style="display: block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); text-decoration: none; transition: transform 0.2s ease, box-shadow 0.2s ease;">
                                <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                    <i class="fas fa-code-branch" style="font-size: 24px; margin-right: 12px; opacity: 0.9;"></i>
                                    <h4 style="margin: 0; font-size: 16px; font-weight: 600;">Historial de Versiones</h4>
                                </div>
                                <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">v2.1.0</div>
                                <div style="font-size: 14px; opacity: 0.9;">
                                    <div>Commits: <span>Ver changelog completo</span></div>
                                    <div style="margin-top: 8px; display: flex; align-items: center; gap: 4px;">
                                        <i class="fas fa-external-link-alt" style="font-size: 12px;"></i>
                                        <span>Hacer clic para ver detalles</span>
                                    </div>
                                </div>
                            </a>
                        </div>


                    </div>
                </div>
            </div>
            

        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Inicialización de métricas del servidor
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystemInfoUpdates();
        });

        // System Information Dynamic Updates
        function initializeSystemInfoUpdates() {
            // Update system info every 30 seconds
            setInterval(updateSystemInfo, 30000);
            
            // Initial update
            updateSystemInfo();
        }

        function updateSystemInfo() {
            fetch('/api/system-metrics')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateSystemCards(data.metrics);
                        updateSystemHealth(data.metrics);
                    }
                })
                .catch(error => {
                    console.error('Error updating system info:', error);
                    updateConnectionStatus(false);
                });
        }

        function updateSystemCards(metrics) {
            // Update Platform Info
            const platformName = document.getElementById('platform-name');
            const platformArch = document.getElementById('platform-arch');
            const platformProcessor = document.getElementById('platform-processor');
            
            if (platformName && metrics.system) {
                platformName.textContent = metrics.system.platform || 'N/A';
            }
            if (platformArch && metrics.system) {
                platformArch.textContent = metrics.system.architecture || 'N/A';
            }
            if (platformProcessor && metrics.system) {
                const processor = metrics.system.processor || 'N/A';
                platformProcessor.textContent = processor.length > 30 ? processor.substring(0, 30) + '...' : processor;
            }

            // Update Process Count
            const processCount = document.getElementById('process-count');
            if (processCount && metrics.system) {
                processCount.textContent = metrics.system.process_count || 'N/A';
            }

            // Update System Uptime
            const systemUptime = document.getElementById('system-uptime');
            const bootTime = document.getElementById('boot-time');
            if (systemUptime && metrics.system) {
                const uptime = metrics.system.uptime_hours || 0;
                systemUptime.textContent = uptime.toFixed(1) + 'h';
            }
            if (bootTime && metrics.system) {
                bootTime.textContent = metrics.system.boot_time || 'N/A';
            }
        }



        function updateSystemHealth(metrics) {
            const systemHealth = document.getElementById('system-health');
            const appStatus = document.getElementById('app-status');
            const dbStatus = document.getElementById('db-status');
            
            if (metrics && metrics.cpu && metrics.memory) {
                // Determine system health based on CPU and memory usage
                const cpuUsage = metrics.cpu.percent || 0;
                const memoryUsage = metrics.memory.percent || 0;
                
                let healthStatus = 'Saludable';
                let healthColor = '#38a169';
                let appStatusText = 'Operativo';
                
                if (cpuUsage > 80 || memoryUsage > 85) {
                    healthStatus = 'Sobrecargado';
                    healthColor = '#e53e3e';
                    appStatusText = 'Bajo Carga';
                } else if (cpuUsage > 60 || memoryUsage > 70) {
                    healthStatus = 'Moderado';
                    healthColor = '#f59e0b';
                    appStatusText = 'Estable';
                }
                
                if (systemHealth) {
                    systemHealth.textContent = healthStatus;
                    systemHealth.style.color = healthColor;
                }
                
                if (appStatus) {
                    appStatus.textContent = appStatusText;
                }
            }
            
            // Update database status (assume connected if we got metrics)
            if (dbStatus) {
                dbStatus.textContent = 'Conectada';
            }
        }

        function updateConnectionStatus(isConnected) {
            const systemHealth = document.getElementById('system-health');
            const appStatus = document.getElementById('app-status');
            const dbStatus = document.getElementById('db-status');
            
            if (!isConnected) {
                if (systemHealth) {
                    systemHealth.textContent = 'Sin Conexión';
                    systemHealth.style.color = '#e53e3e';
                }
                if (appStatus) {
                    appStatus.textContent = 'Desconectado';
                }
                if (dbStatus) {
                    dbStatus.textContent = 'Sin Conexión';
                }
            }
        }

        // Add visual feedback for real-time updates
        function addUpdateIndicator() {
            const indicators = document.querySelectorAll('[id$="-status"], [id$="-uptime"], [id$="-count"]');
            indicators.forEach(indicator => {
                indicator.style.transition = 'all 0.3s ease';
                indicator.classList.add('updating');
                setTimeout(() => {
                    indicator.classList.remove('updating');
                }, 300);
            });
        }
    </script>
    
    <!-- Funciones de notificaciones -->
    <script src="{{ url_for('static', filename='js/notification_functions.js') }}"></script>
    
    <!-- Include Notifications Modal Component -->
    {% include 'components/modals/notificaciones/notifications_modal.html' %}
    
    <!-- Include Configuration Modal Component -->
    {% include 'components/modals/configuracion/config_modal.html' %}
{% endblock %}