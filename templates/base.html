<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ titulo }}{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    {% block content %}{% endblock %}

    <!-- Include Footer Component -->
    {% include 'components/partials/footer.html' %}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Mobile Navigation Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mobileToggle = document.getElementById('mobileMenuToggle');
            const mobileOverlay = document.getElementById('mobileOverlay');
            const sidebar = document.querySelector('.sidebar');
            
            // Solo ejecutar en dispositivos móviles
            function isMobile() {
                return window.innerWidth <= 768;
            }
            
            // Mostrar/ocultar elementos móviles según el tamaño de pantalla
            function handleResize() {
                if (isMobile()) {
                    if (mobileToggle) mobileToggle.style.display = 'flex';
                } else {
                    if (mobileToggle) mobileToggle.style.display = 'none';
                    if (sidebar) sidebar.classList.remove('mobile-open');
                    if (mobileOverlay) {
                        mobileOverlay.classList.remove('active');
                        mobileOverlay.style.display = 'none';
                    }
                }
            }
            
            // Ejecutar al cargar y al redimensionar
            handleResize();
            window.addEventListener('resize', handleResize);
            
            if (mobileToggle && sidebar) {
                // Toggle mobile menu
                mobileToggle.addEventListener('click', function() {
                    if (!isMobile()) return; // Solo funcionar en móviles
                    
                    sidebar.classList.toggle('mobile-open');
                    const isOpen = sidebar.classList.contains('mobile-open');
                    
                    if (mobileOverlay) {
                        mobileOverlay.style.display = isOpen ? 'block' : 'none';
                        setTimeout(() => {
                            mobileOverlay.classList.toggle('active', isOpen);
                        }, 10);
                    }
                });
                
                // Close menu when clicking overlay
                if (mobileOverlay) {
                    mobileOverlay.addEventListener('click', function() {
                        sidebar.classList.remove('mobile-open');
                        mobileOverlay.classList.remove('active');
                        setTimeout(() => {
                            mobileOverlay.style.display = 'none';
                        }, 300);
                    });
                }
                
                // Close menu when clicking nav links on mobile
                const navLinks = sidebar.querySelectorAll('.nav-link');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (isMobile()) {
                            sidebar.classList.remove('mobile-open');
                            if (mobileOverlay) {
                                mobileOverlay.classList.remove('active');
                                setTimeout(() => {
                                    mobileOverlay.style.display = 'none';
                                }, 300);
                            }
                        }
                    });
                });
            }
            
            // Avatar generation function
            window.generateAvatar = function(name, className = 'user-avatar-small') {
                if (!name) name = 'Usuario';
                
                const words = name.trim().split(' ');
                let initials = '';
                
                if (words.length >= 2) {
                    initials = words[0][0] + words[1][0];
                } else {
                    initials = words[0][0] + (words[0][1] || '');
                }
                
                return `<div class="${className} avatar-generated">${initials.toUpperCase()}</div>`;
            };
            
            window.generateCustomerAvatar = function(name, colorClass = '') {
                if (!name) name = 'Cliente';
                
                const words = name.trim().split(' ');
                let initials = '';
                
                if (words.length >= 2) {
                    initials = words[0][0] + words[1][0];
                } else {
                    initials = words[0][0] + (words[0][1] || '');
                }
                
                const className = `customer-avatar avatar-generated ${colorClass}`.trim();
                return `<div class="${className}">${initials.toUpperCase()}</div>`;
            };
            
            // Replace placeholder images immediately
            function replaceePlaceholderImages() {
                const placeholderImages = document.querySelectorAll('img[src*="via.placeholder.com"]');
                placeholderImages.forEach(img => {
                    const alt = img.alt || 'Usuario';
                    const className = img.className;
                    
                    if (className.includes('customer-avatar')) {
                        // Extract color from original URL if present
                        let colorClass = '';
                        if (img.src.includes('3b82f6')) colorClass = '';
                        else if (img.src.includes('10b981')) colorClass = 'color-green';
                        else if (img.src.includes('f59e0b')) colorClass = 'color-yellow';
                        else if (img.src.includes('ef4444')) colorClass = 'color-red';
                        else if (img.src.includes('8b5cf6')) colorClass = 'color-purple';
                        else if (img.src.includes('ec4899')) colorClass = 'color-pink';
                        
                        img.outerHTML = generateCustomerAvatar(alt, colorClass);
                    } else {
                        img.outerHTML = generateAvatar(alt, className);
                    }
                });
            }
            
            // Replace images on DOM ready and after a short delay
            replaceePlaceholderImages();
            setTimeout(replaceePlaceholderImages, 50);
        });
    </script>
    
    <!-- Funciones del sidebar cargadas desde archivo modular -->
    <script src="{{ url_for('static', filename='js/sidebar_functions.js') }}"></script>
    
    <!-- Componente de Modal de Confirmación Reutilizable -->
    <script src="{{ url_for('static', filename='js/confirm_modal.js') }}"></script>
    
    <!-- Sistema unificado de toasts -->
    {% include 'components/partials/toast_container.html' %}
    
    <!-- Script de inicialización de datos de ejemplo -->
    <script src="{{ url_for('static', filename='js/init_sample_data.js') }}"></script>
    
    <!-- Inicializar datos de ejemplo si es necesario -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Solo mostrar el modal de inicialización en el dashboard principal
            if (window.location.pathname === '/' || window.location.pathname === '/dashboard') {
                const sampleDataInit = new SampleDataInitializer();
                sampleDataInit.checkAndInitialize();
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>