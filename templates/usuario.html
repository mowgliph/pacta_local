{% extends "base.html" %}

{% block title %}Perfil de Usuario - PACTA{% endblock %}

{% block content %}
    <div class="dashboard-container">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="main-content">
            {% set page_title = "Perfil de Usuario" %}
            {% set page_subtitle = "Gestiona tu información personal y configuraciones" %}
            {% set page_icon = "fas fa-user-circle" %}
            {% set buttons = [
                {
                    'text': 'Editar Perfil',
                    'icon': 'fas fa-edit',
                    'class': 'btn-outline-primary',
                    'action': 'edit'
                },
                {
                    'text': 'Guardar Cambios',
                    'icon': 'fas fa-save',
                    'class': 'btn-primary',
                    'action': 'save'
                }
            ] %}
            {% set stats = [
                {
                    'value': usuario.ultimo_acceso or 'Hoy',
                    'label': 'Último acceso'
                },
                {
                    'value': usuario.rol or 'Administrador',
                    'label': 'Rol'
                }
            ] %}
            {% set show_notifications = true %}
            {% set show_user_menu = true %}
            {% include 'components/partials/content_header.html' %}
            
            <!-- User Profile Card -->
            <div class="card card-lg mb-4 user-profile-card">
                <div class="card-body">
                    <div class="d-flex align-items-center gap-4 mb-4">
                    <div class="avatar avatar-2xl avatar-purple user-avatar-large">
                        {{ (usuario.nombre or 'Ana Martínez').split()[0][0] }}{{ (usuario.nombre or 'Ana Martínez').split()[1][0] if (usuario.nombre or 'Ana Martínez').split()|length > 1 else '' }}
                    </div>
                    <div class="flex-1">
                        <h2 class="mb-2">{{ usuario.nombre or 'Ana Martínez' }}</h2>
                        <p class="text-secondary mb-3">{{ usuario.cargo or 'Gerente de Operaciones' }}</p>
                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <span class="d-flex align-items-center gap-2 text-secondary">
                                <i class="fas fa-user text-muted"></i>
                                <span id="userUsername">{{ usuario.username or 'N/A' }}</span>
                            </span>
                            <span class="d-flex align-items-center gap-2 text-secondary">
                                <i class="fas fa-envelope text-muted"></i>
                                <span id="userEmail">{{ usuario.email or 'N/A' }}</span>
                            </span>
                            <span class="d-flex align-items-center gap-2 text-secondary">
                                <i class="fas fa-phone text-muted"></i>
                                <span id="userPhone">{{ usuario.telefono or 'No especificado' }}</span>
                            </span>
                        </div>
                    </div>
                    <div class="d-flex flex-column gap-2">
                        <div class="card card-sm card-info text-center">
                            <div class="card-body p-3">
                                <div class="fs-4 fw-bold text-info">{{ usuario.dias_activo or 0 }}</div>
                                <div class="small text-info">Días Activo</div>
                            </div>
                        </div>
                        <div class="card card-sm card-success text-center">
                            <div class="card-body p-3">
                                <div class="fs-4 fw-bold text-success">{{ usuario.nivel_acceso or 'Usuario' }}</div>
                                <div class="small text-success">Nivel de Acceso</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Form (Hidden by default) -->
                <div id="editForm" class="border-t border-light pt-4 hidden">
                    <form id="profileForm">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="form-label">Nombre Completo *</label>
                                <input type="text" id="editNombre" name="nombre" value="{{ usuario.nombre or '' }}" required class="form-control">
                            </div>
                            <div>
                                <label class="form-label">Cargo</label>
                                <input type="text" id="editCargo" name="cargo" value="{{ usuario.cargo or '' }}" class="form-control">
                            </div>
                            <div>
                                <label class="form-label">Email *</label>
                                <input type="email" id="editEmail" name="email" value="{{ usuario.email or '' }}" required class="form-control">
                            </div>
                            <div>
                                <label class="form-label">Teléfono</label>
                                <input type="tel" id="editTelefono" name="telefono" value="{{ usuario.telefono or '' }}" class="form-control">
                            </div>
                            <div class="col-span-full">
                                <label class="form-label">Departamento</label>
                                <input type="text" id="editDepartamento" name="departamento" value="{{ usuario.departamento or '' }}" class="form-control">
                            </div>
                        </div>
                        
                        <!-- Sección de cambio de contraseña -->
                        <div class="border-t border-light pt-4 mb-4">
                            <h4 class="mb-3">Cambiar Contraseña (Opcional)</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="form-label">Contraseña Actual</label>
                                    <input type="password" id="passwordActual" name="password_actual" class="form-control">
                                </div>
                                <div>
                                    <label class="form-label">Nueva Contraseña</label>
                                    <input type="password" id="nuevaPassword" name="nueva_password" class="form-control">
                                </div>
                                <div>
                                    <label class="form-label">Confirmar Contraseña</label>
                                    <input type="password" id="confirmarPassword" name="confirmar_password" class="form-control">
                                </div>
                            </div>
                            <div class="mt-2 text-secondary small d-flex align-items-center">
                                <i class="fas fa-info-circle me-1"></i>
                                Deja estos campos vacíos si no deseas cambiar tu contraseña
                            </div>
                        </div>
                    </form>
                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <button onclick="cancelEdit()" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>
                            Cancelar
                        </button>
                        <button onclick="saveChanges()" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>
                            Guardar Cambios
                        </button>
                    </div>
                </div>
                </div>
            </div>
            
            <!-- Tarjetas de Métricas -->
            <div class="metrics-grid">
                {% set metric_label = "Contratos Activos" %}
                {% set metric_value = estadisticas.contratos_activos or 156 %}
                {% set metric_icon = "fas fa-file-contract" %}
                {% set metric_color = "text-primary" %}
                {% set metric_change = "+12 este mes" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Valor Total" %}
                {% set metric_value = "$" ~ (estadisticas.valor_total or '2.4M') %}
                {% set metric_icon = "fas fa-dollar-sign" %}
                {% set metric_color = "text-success" %}
                {% set metric_change = "+8.2% vs mes anterior" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Próximos a Vencer" %}
                {% set metric_value = estadisticas.proximos_vencer or 23 %}
                {% set metric_icon = "fas fa-clock" %}
                {% set metric_color = "text-warning" %}
                {% set metric_change = "Requieren atención" %}
                {% set change_type = "negative" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Reportes Generados" %}
                {% set metric_value = estadisticas.reportes_generados or 89 %}
                {% set metric_icon = "fas fa-chart-bar" %}
                {% set metric_color = "text-purple" %}
                {% set metric_change = "+15 esta semana" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Vertical Blocks Layout -->
            <div class="vertical-blocks">
                <!-- Quick Actions Block -->
                <div class="block-section actions-block">
                    <div class="block-header">
                        <h3 class="block-title">Acciones Rápidas</h3>
                        <p class="block-subtitle">Herramientas y funciones principales</p>
                    </div>
                    <div class="block-content">
                        <div class="d-flex flex-wrap gap-3">
                            <button class="btn btn-primary flex-fill d-flex align-items-center gap-2 min-w-200" onclick="openNewUserModal()">
                                <i class="fas fa-user-plus"></i>
                                Nuevo Usuario
                            </button>
                            <a href="{{ url_for('users.usuarios_lista') }}" class="btn btn-success flex-fill d-flex align-items-center gap-2 min-w-200">
                                <i class="fas fa-users"></i>
                                Ver Lista de Usuarios
                            </a>
                            <button class="btn btn-warning flex-fill d-flex align-items-center gap-2 min-w-200" onclick="openNotificationsModal()">
                                <i class="fas fa-bell"></i>
                                Ver Notificaciones
                            </button>
                            <a href="{{ url_for('main.configuracion') }}" class="btn btn-purple flex-fill d-flex align-items-center gap-2 min-w-200">
                                <i class="fas fa-cog"></i>
                                Configuraciones
                            </a>
                        </div>
                    </div>
                </div>
                

                <!-- Recent Activity Block -->
                <div class="block-section activity-block">
                    <div class="block-header">
                        <h3 class="block-title">Actividad Reciente</h3>
                        <p class="block-subtitle">Últimas acciones realizadas por el usuario</p>
                    </div>
                    <div class="block-content">
                        <div>
                            {% for actividad in actividades[:5] %}
                            {% set dot_color_class = 'status-color-gray' %}
                            {% if actividad.estado_clase and 'success' in actividad.estado_clase %}
                                {% set dot_color_class = 'status-color-success' %}
                            {% elif actividad.estado_clase and ('warn' in actividad.estado_clase or 'warning' in actividad.estado_clase) %}
                                {% set dot_color_class = 'status-color-warning' %}
                            {% elif actividad.estado_clase and ('error' in actividad.estado_clase or 'danger' in actividad.estado_clase) %}
                                {% set dot_color_class = 'status-color-error' %}
                            {% elif actividad.estado_clase and 'info' in actividad.estado_clase %}
                                {% set dot_color_class = 'status-color-info' %}
                            {% endif %}
                            <div class="activity-item">
                                <span class="status-dot status-dot-sm {{ dot_color_class }}"></span>
                                <div class="activity-content">
                                    <div class="activity-message"><strong>{{ actividad.accion }}</strong></div>
                                    <div class="activity-message">{{ actividad.descripcion }}</div>
                                    <div class="activity-time">{{ actividad.fecha }}</div>
                                </div>
                                <div>
                                    <span class="status-badge {{ actividad.estado_clase }}">{{ actividad.estado }}</span>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if not actividades %}
                            <div class="activity-item">
                                <span class="status-dot status-dot-sm status-color-gray"></span>
                                <div class="activity-content">
                                    <div class="activity-message"><strong>Sin actividad reciente</strong></div>
                                    <div class="activity-message">No hay actividades registradas para este usuario</div>
                                    <div class="activity-time">Sistema</div>
                                </div>
                                <div>
                                    <span class="status-badge status-info">Info</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                
                <!-- Personal Statistics Block -->
                <div class="block-section activity-block">
                    <div class="block-header">
                        <h3 class="block-title">Estadísticas Personales</h3>
                        <p class="block-subtitle">Métricas de desempeño individual</p>
                    </div>
                    <div class="block-content">
                        <div class="d-flex flex-column gap-3">
                            <div class="card card-sm">
                                <div class="card-body py-3 d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold">Contratos Creados</span>
                                    <span class="fw-semibold text-primary">{{ estadisticas_personales.contratos_creados }}</span>
                                </div>
                            </div>
                            <div class="card card-sm">
                                <div class="card-body py-3 d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold">Reportes Generados</span>
                                    <span class="fw-semibold text-success">{{ estadisticas_personales.reportes_generados }}</span>
                                </div>
                            </div>
                            <div class="card card-sm">
                                <div class="card-body py-3 d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold">Último Acceso</span>
                                    <span class="fw-semibold text-muted">{{ estadisticas_personales.ultimo_acceso }}</span>
                                </div>
                            </div>
                            <div class="card card-sm">
                                <div class="card-body py-3 d-flex justify-content-between align-items-center">
                                    <span class="fw-semibold">Sesiones Este Mes</span>
                                    <span class="fw-semibold text-purple">{{ estadisticas_personales.sesiones_mes }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include Notifications Modal Component -->
    <div id="notificationsModalContainer"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/notification_functions.js') }}"></script>
    <script>
        // Las funciones de edición están definidas en user_functions.js
        
        function saveChanges() {
            // Get form values
            const nombre = document.getElementById('editNombre').value;
            const cargo = document.getElementById('editCargo').value;
            const email = document.getElementById('editEmail').value;
            const telefono = document.getElementById('editTelefono').value;
            
            // Update display values
            document.querySelector('h2').textContent = nombre;
            document.querySelector('p').textContent = cargo;
            document.getElementById('userEmail').textContent = email;
            document.getElementById('userPhone').textContent = telefono;
            document.querySelector('.user-name-small').textContent = nombre;
            
            // Update avatar initials
            const nameParts = nombre.split(' ');
            const initials = nameParts[0][0] + (nameParts[1] ? nameParts[1][0] : '');
            document.querySelector('.user-avatar-large').textContent = initials;
            
            // Here you would typically send the data to the server
            // For now, we'll just show a success message
            alert('Perfil actualizado exitosamente');
            
            toggleEditMode();
        }
        
        // Add some CSS for the action cells
        const style = document.createElement('style');
        style.textContent = `
            .action-cell {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .action-cell i {
                width: 16px;
                text-align: center;
            }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- Include User Modal Component -->
    {% include 'components/modals/usuarios/user_modal.html' %}
    
    <!-- Include Notifications Modal Component -->
    {% include 'components/modals/notificaciones/notifications_modal.html' %}
{% endblock %}