{% extends "base.html" %}

{% block title %}Perfil de Usuario - PACTA{% endblock %}

{% block content %}
    <div class="dashboard-container">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="main-content">
            {% set page_title = "Perfil de Usuario" %}
            {% set page_subtitle = "Gestiona tu información personal y configuraciones" %}
            {% set page_icon = "fas fa-user-circle" %}
            {% set buttons = [
                {
                    'text': 'Editar Perfil',
                    'icon': 'fas fa-edit',
                    'class': 'btn-outline-primary',
                    'action': 'edit'
                },
                {
                    'text': 'Guardar Cambios',
                    'icon': 'fas fa-save',
                    'class': 'btn-primary',
                    'action': 'save'
                }
            ] %}
            {% set stats = [
                {
                    'value': usuario.ultimo_acceso or 'Hoy',
                    'label': 'Último acceso'
                },
                {
                    'value': usuario.rol or 'Administrador',
                    'label': 'Rol'
                }
            ] %}
            {% set show_notifications = true %}
            {% set show_user_menu = true %}
            {% include 'components/partials/content_header.html' %}
            
            <!-- User Profile Card -->
            <div class="user-profile-card" style="background: white; border-radius: 16px; padding: 32px; margin-bottom: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 32px;">
                    <div class="user-avatar-large" style="width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: bold;">
                        {{ (usuario.nombre or 'Ana Martínez').split()[0][0] }}{{ (usuario.nombre or 'Ana Martínez').split()[1][0] if (usuario.nombre or 'Ana Martínez').split()|length > 1 else '' }}
                    </div>
                    <div style="flex: 1;">
                        <h2 style="color: #1f2937; margin-bottom: 8px; font-size: 28px;">{{ usuario.nombre or 'Ana Martínez' }}</h2>
                        <p style="color: #6b7280; margin-bottom: 16px; font-size: 16px;">{{ usuario.cargo or 'Gerente de Operaciones' }}</p>
                        <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
                            <span style="display: flex; align-items: center; gap: 8px; color: #374151;">
                                <i class="fas fa-user" style="color: #6b7280;"></i>
                                <span id="userUsername">{{ usuario.username or 'N/A' }}</span>
                            </span>
                            <span style="display: flex; align-items: center; gap: 8px; color: #374151;">
                                <i class="fas fa-envelope" style="color: #6b7280;"></i>
                                <span id="userEmail">{{ usuario.email or 'N/A' }}</span>
                            </span>
                            <span style="display: flex; align-items: center; gap: 8px; color: #374151;">
                                <i class="fas fa-phone" style="color: #6b7280;"></i>
                                <span id="userPhone">{{ usuario.telefono or 'No especificado' }}</span>
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="text-align: center; padding: 16px; background: #f0f9ff; border-radius: 12px; border: 1px solid #0ea5e9;">
                            <div style="font-size: 24px; font-weight: bold; color: #0ea5e9;">{{ usuario.dias_activo or 0 }}</div>
                            <div style="font-size: 12px; color: #0369a1; font-weight: 500;">Días Activo</div>
                        </div>
                        <div style="text-align: center; padding: 16px; background: #f0fdf4; border-radius: 12px; border: 1px solid #10b981;">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">{{ usuario.nivel_acceso or 'Usuario' }}</div>
                            <div style="font-size: 12px; color: #047857; font-weight: 500;">Nivel de Acceso</div>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Form (Hidden by default) -->
                <div id="editForm" style="display: none; border-top: 1px solid #e5e7eb; padding-top: 24px;">
                    <form id="profileForm">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Nombre Completo *</label>
                                <input type="text" id="editNombre" name="nombre" value="{{ usuario.nombre or '' }}" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Cargo</label>
                                <input type="text" id="editCargo" name="cargo" value="{{ usuario.cargo or '' }}" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Email *</label>
                                <input type="email" id="editEmail" name="email" value="{{ usuario.email or '' }}" required style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Teléfono</label>
                                <input type="tel" id="editTelefono" name="telefono" value="{{ usuario.telefono or '' }}" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Departamento</label>
                                <input type="text" id="editDepartamento" name="departamento" value="{{ usuario.departamento or '' }}" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                        
                        <!-- Sección de cambio de contraseña -->
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 24px; margin-bottom: 24px;">
                            <h4 style="color: #374151; margin-bottom: 16px; font-size: 16px;">Cambiar Contraseña (Opcional)</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Contraseña Actual</label>
                                    <input type="password" id="passwordActual" name="password_actual" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Nueva Contraseña</label>
                                    <input type="password" id="nuevaPassword" name="nueva_password" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #374151;">Confirmar Contraseña</label>
                                    <input type="password" id="confirmarPassword" name="confirmar_password" style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                                Deja estos campos vacíos si no deseas cambiar tu contraseña
                            </div>
                        </div>
                    </form>
                    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;">
                        <button onclick="cancelEdit()" class="btn btn-secondary">
                            <i class="fas fa-times" style="margin-right: 8px;"></i>
                            Cancelar
                        </button>
                        <button onclick="saveChanges()" class="btn btn-success">
                            <i class="fas fa-save" style="margin-right: 8px;"></i>
                            Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tarjetas de Métricas -->
            <div class="metrics-grid">
                {% set metric_label = "Contratos Activos" %}
                {% set metric_value = estadisticas.contratos_activos or 156 %}
                {% set metric_icon = "fas fa-file-contract" %}
                {% set metric_color = "text-primary" %}
                {% set metric_change = "+12 este mes" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Valor Total" %}
                {% set metric_value = "$" ~ (estadisticas.valor_total or '2.4M') %}
                {% set metric_icon = "fas fa-dollar-sign" %}
                {% set metric_color = "text-success" %}
                {% set metric_change = "+8.2% vs mes anterior" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Próximos a Vencer" %}
                {% set metric_value = estadisticas.proximos_vencer or 23 %}
                {% set metric_icon = "fas fa-clock" %}
                {% set metric_color = "text-warning" %}
                {% set metric_change = "Requieren atención" %}
                {% set change_type = "negative" %}
                {% include 'components/partials/metric_card.html' %}
                
                {% set metric_label = "Reportes Generados" %}
                {% set metric_value = estadisticas.reportes_generados or 89 %}
                {% set metric_icon = "fas fa-chart-bar" %}
                {% set metric_color = "text-purple" %}
                {% set metric_change = "+15 esta semana" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Vertical Blocks Layout -->
            <div class="vertical-blocks">
                <!-- Quick Actions Block -->
                <div class="block-section actions-block">
                    <div class="block-header">
                        <h3 class="block-title">Acciones Rápidas</h3>
                        <p class="block-subtitle">Herramientas y funciones principales</p>
                    </div>
                    <div class="block-content">
                        <div class="d-flex flex-wrap gap-3">
                            <button class="btn btn-primary flex-fill d-flex align-items-center gap-2" onclick="openNewUserModal()" style="min-width: 200px;">
                                <i class="fas fa-user-plus"></i>
                                Nuevo Usuario
                            </button>
                            <button class="btn btn-success flex-fill d-flex align-items-center gap-2" onclick="window.location.href='{{ url_for('users.usuarios_lista') }}'" style="min-width: 200px;">
                                <i class="fas fa-users"></i>
                                Ver Lista de Usuarios
                            </button>
                            <button class="btn btn-warning flex-fill d-flex align-items-center gap-2" onclick="openNotificationsModal()" style="min-width: 200px;">
                                <i class="fas fa-bell"></i>
                                Ver Notificaciones
                            </button>
                            <button class="btn btn-purple flex-fill d-flex align-items-center gap-2" onclick="window.location.href='{{ url_for('main.configuracion') }}'" style="min-width: 200px;">
                                <i class="fas fa-cog"></i>
                                Configuraciones
                            </button>
                        </div>
                    </div>
                </div>
                

                <!-- Recent Activity Block -->
                <div class="block-section activity-block">
                    <div class="block-header">
                        <h3 class="block-title">Actividad Reciente</h3>
                        <p class="block-subtitle">Últimas acciones realizadas por el usuario</p>
                    </div>
                    <div class="block-content">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            {% for actividad in actividades[:5] %}
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <div style="width: 8px; height: 8px; background: {{ actividad.color }}; border-radius: 50%;"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 500;">{{ actividad.accion }}</div>
                                    <div style="font-size: 12px; color: #64748b;">{{ actividad.descripcion }}</div>
                                    <div style="font-size: 11px; color: #94a3b8;">{{ actividad.fecha }}</div>
                                </div>
                                <div>
                                    <span class="status-badge {{ actividad.estado_clase }}">{{ actividad.estado }}</span>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if not actividades %}
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <div style="width: 8px; height: 8px; background: #6b7280; border-radius: 50%;"></div>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 500;">Sin actividad reciente</div>
                                    <div style="font-size: 12px; color: #64748b;">No hay actividades registradas para este usuario</div>
                                    <div style="font-size: 11px; color: #94a3b8;">Sistema</div>
                                </div>
                                <div>
                                    <span class="status-badge status-info">Info</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                
                <!-- Personal Statistics Block -->
                <div class="block-section activity-block">
                    <div class="block-header">
                        <h3 class="block-title">Estadísticas Personales</h3>
                        <p class="block-subtitle">Métricas de desempeño individual</p>
                    </div>
                    <div class="block-content">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <span style="font-weight: 500; color: #374151;">Contratos Creados</span>
                                <span style="color: #3b82f6; font-weight: 600;">{{ estadisticas_personales.contratos_creados }}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <span style="font-weight: 500; color: #374151;">Reportes Generados</span>
                                <span style="color: #10b981; font-weight: 600;">{{ estadisticas_personales.reportes_generados }}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <span style="font-weight: 500; color: #374151;">Último Acceso</span>
                                <span style="color: #64748b; font-weight: 600;">{{ estadisticas_personales.ultimo_acceso }}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px;">
                                <span style="font-weight: 500; color: #374151;">Sesiones Este Mes</span>
                                <span style="color: #8b5cf6; font-weight: 600;">{{ estadisticas_personales.sesiones_mes }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include Notifications Modal Component -->
    <div id="notificationsModalContainer"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/notification_functions.js') }}"></script>
    <script>
        // Las funciones de edición están definidas en user_functions.js
        
        function saveChanges() {
            // Get form values
            const nombre = document.getElementById('editNombre').value;
            const cargo = document.getElementById('editCargo').value;
            const email = document.getElementById('editEmail').value;
            const telefono = document.getElementById('editTelefono').value;
            
            // Update display values
            document.querySelector('h2').textContent = nombre;
            document.querySelector('p').textContent = cargo;
            document.getElementById('userEmail').textContent = email;
            document.getElementById('userPhone').textContent = telefono;
            document.querySelector('.user-name-small').textContent = nombre;
            
            // Update avatar initials
            const nameParts = nombre.split(' ');
            const initials = nameParts[0][0] + (nameParts[1] ? nameParts[1][0] : '');
            document.querySelector('.user-avatar-large').textContent = initials;
            
            // Here you would typically send the data to the server
            // For now, we'll just show a success message
            alert('Perfil actualizado exitosamente');
            
            toggleEditMode();
        }
        
        // Add some CSS for the action cells
        const style = document.createElement('style');
        style.textContent = `
            .action-cell {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .action-cell i {
                width: 16px;
                text-align: center;
            }
        `;
        document.head.appendChild(style);
    </script>
    
    <!-- Include User Modal Component -->
    {% include 'components/modals/usuarios/user_modal.html' %}
    
    <!-- Include Notifications Modal Component -->
    {% include 'components/modals/notificaciones/notifications_modal.html' %}
{% endblock %}