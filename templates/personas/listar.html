{% extends "base.html" %}

{% block title %}Gestión de Personas Responsables - PACTA{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- Include Sidebar Component -->
        {% include 'components/partials/sidebar.html' %}
        
        <!-- Main Content -->
        <div class="row g-0">
            <!-- Content Header -->
            {% set page_title = "Gestión de Personas Responsables" %}
            {% set page_subtitle = "Administra todas las personas responsables del sistema" %}
            {% set page_icon = "fas fa-users" %}
            {% set show_notifications = true %}
            {% set show_user_menu = true %}
            {% include 'components/partials/content_header.html' %}

            <!-- Personas Statistics Cards -->
            <div class="row g-3 mb-4">
                <!-- Total Personas -->
                {% set metric_label = "Total Personas" %}
                {% set metric_value = estadisticas.total_personas if estadisticas and estadisticas.total_personas else "0" %}
                {% set metric_icon = "fas fa-users" %}
                {% set metric_color = "text-primary" %}
                {% if estadisticas and estadisticas.cambio_personas is defined %}
                    {% set cambio = estadisticas.cambio_personas %}
                    {% set metric_change = ("+" + cambio|string + " este mes") if cambio >= 0 else (cambio|string + " este mes") %}
                    {% set change_type = "positive" if cambio >= 0 else "negative" %}
                {% else %}
                    {% set metric_change = "0 este mes" %}
                    {% set change_type = "neutral" %}
                {% endif %}
                {% include 'components/partials/metric_card.html' %}
                
                <!-- Personas Activas -->
                {% set metric_label = "Personas Activas" %}
                {% set metric_value = estadisticas.personas_activas if estadisticas and estadisticas.personas_activas else "0" %}
                {% set metric_icon = "fas fa-check-circle" %}
                {% set metric_color = "text-success" %}
                {% if estadisticas and estadisticas.porcentaje_activas is defined %}
                    {% set metric_change = estadisticas.porcentaje_activas|string + "% del total" %}
                {% else %}
                    {% set metric_change = "0% del total" %}
                {% endif %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                <!-- Personas Principales -->
                {% set metric_label = "Personas Principales" %}
                {% set metric_value = estadisticas.personas_principales if estadisticas and estadisticas.personas_principales else "0" %}
                {% set metric_icon = "fas fa-star" %}
                {% set metric_color = "text-warning" %}
                {% if estadisticas and estadisticas.porcentaje_principales is defined %}
                    {% set metric_change = estadisticas.porcentaje_principales|string + "% del total" %}
                {% else %}
                    {% set metric_change = "0% del total" %}
                {% endif %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
                
                <!-- Clientes con Personas -->
                {% set metric_label = "Clientes con Personas" %}
                {% set metric_value = estadisticas.clientes_con_personas if estadisticas and estadisticas.clientes_con_personas else "0" %}
                {% set metric_icon = "fas fa-building" %}
                {% set metric_color = "text-purple" %}
                {% set metric_change = "Clientes activos" %}
                {% set change_type = "positive" %}
                {% include 'components/partials/metric_card.html' %}
            </div>
            
            <!-- Tabla de Personas Responsables -->
            <div class="card mb-4">
                <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="h4 mb-1">Personas Responsables del Sistema</h3>
                        <p class="text-muted mb-0">Lista completa de personas responsables registradas</p>
                    </div>
                </div>
                <div class="mt-4">
                    <!-- Barra de acciones -->
                    <div class="d-flex justify-content-between align-items-center p-4 bg-light border-bottom">
                        <div class="d-flex gap-2">
                            <button id="btnAddPersona" class="btn btn-primary" title="Añadir Persona Responsable">
                                <i class="fas fa-plus me-2"></i>
                                Añadir Persona Responsable
                            </button>
                            <button id="btnSearchPersona" class="btn btn-secondary" title="Buscar Personas">
                                <i class="fas fa-search me-2"></i>
                                Buscar Personas
                            </button>
                        </div>
                        <div id="searchContainer" class="d-none d-md-block">
                            <input type="text" id="searchInput" placeholder="Buscar personas..." class="form-control">
                        </div>
                    </div>
                    
                    <!-- Tabla de Personas -->
                    <div class="table-responsive">
                        <table class="table table-hover table-striped personas-table">
                            <thead>
                                <tr>
                                    <th scope="col" class="sortable">Nombre <span class="sort-icon"></span></th>
                                    <th scope="col" class="sortable">Cliente <span class="sort-icon"></span></th>
                                    <th scope="col" class="sortable">Cargo <span class="sort-icon"></span></th>
                                    <th scope="col" class="sortable">Email <span class="sort-icon"></span></th>
                                    <th scope="col" class="sortable">Teléfono <span class="sort-icon"></span></th>
                                    <th scope="col" class="sortable">Principal <span class="sort-icon"></span></th>
                                    <th scope="col" class="sortable">Estado <span class="sort-icon"></span></th>
                                    <th scope="col">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="personasTableBody">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    </div>
                </div>
            </div>
            
            <!-- Separador -->
            <div style="margin: 32px 0;"></div>
            
            <!-- Gestión de Proveedores y Clientes -->
            {% set providers_api_url = "/api/providers-summary" %}
            {% set clients_api_url = "/api/clients-summary" %}
            {% set data_max_items = "3" %}
            {% set data_title = "Proveedores y Clientes Principales" %}
            {% set data_subtitle = "Vista rápida de los principales proveedores y clientes del sistema" %}
            {% set data_providers_manage_url = "/proveedores" %}
            {% set data_clients_manage_url = "/clientes" %}
            {% set component_id = "providers-clients-main" %}
            {% include 'components/partials/providers-clients-block.html' with context %}

        </div>
    </div>
    
    <!-- Include Persona Modal Component -->
    {% include 'components/modals/personas/persona_modal.html' %}

{% endblock %}

{% block extra_css %}

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/personas.js') }}"></script>
<script src="{{ url_for('static', filename='js/providers-clients-block.js') }}"></script>
{% endblock %}