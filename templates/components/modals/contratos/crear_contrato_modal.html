<!-- Modal para Crear Nuevo Contrato -->
<div class="modal fade" id="crearContratoModal" tabindex="-1" aria-labelledby="crearContratoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crearContratoModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Crear Nuevo Contrato
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Formulario principal -->
                        <form method="POST" action="{{ url_for('contratos.crear') }}" enctype="multipart/form-data" id="formContratoModal">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="numero_contrato_modal" class="form-label">Número de Contrato <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="numero_contrato_modal" name="numero_contrato" required>
                                        <div class="form-text">Identificador único del contrato</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="cliente_id_modal" class="form-label">Cliente/Proveedor <span class="text-danger">*</span></label>
                                        <select class="form-select" id="cliente_id_modal" name="cliente_id" required>
                                            <option value="">Seleccionar...</option>
                                            {% for cliente in clientes %}
                                                <option value="{{ cliente.id }}">
                                                    {{ cliente.nombre }} ({{ cliente.tipo_cliente|title }})
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="persona_responsable_id_modal" class="form-label">Persona Responsable</label>
                                        <select class="form-select" id="persona_responsable_id_modal" name="persona_responsable_id">
                                            <option value="">Seleccionar cliente primero...</option>
                                        </select>
                                        <div class="form-text">Contacto principal del cliente para este contrato</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="tipo_contrato_modal" class="form-label">Tipo de Contrato</label>
                                        <select class="form-select" id="tipo_contrato_modal" name="tipo_contrato">
                                            <option value="">Seleccionar...</option>
                                            {% for tipo in tipos_contrato %}
                                                <option value="{{ tipo }}">{{ tipo }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="titulo_modal" class="form-label">Título del Contrato <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="titulo_modal" name="titulo" required>
                            </div>

                            <div class="mb-3">
                                <label for="descripcion_modal" class="form-label">Descripción</label>
                                <textarea class="form-control" id="descripcion_modal" name="descripcion" rows="3" 
                                          placeholder="Descripción detallada del contrato..."></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="monto_original_modal" class="form-label">Monto Original <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="monto_original_modal" name="monto_original" 
                                                   step="0.01" min="0" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="fecha_inicio_modal" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="fecha_inicio_modal" name="fecha_inicio" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="fecha_fin_modal" class="form-label">Fecha de Fin <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="fecha_fin_modal" name="fecha_fin" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="estado_modal" class="form-label">Estado Inicial</label>
                                        <select class="form-select" id="estado_modal" name="estado">
                                            {% for estado_opt in estados %}
                                                <option value="{{ estado_opt }}" 
                                                        {% if estado_opt == 'borrador' %}selected{% endif %}>
                                                    {{ estado_opt|title }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="archivo_contrato_modal" class="form-label">Documento del Contrato</label>
                                        <input type="file" class="form-control" id="archivo_contrato_modal" name="archivo_contrato" 
                                               accept=".pdf,.doc,.docx">
                                        <div class="form-text">Formatos permitidos: PDF, DOC, DOCX</div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="col-lg-4">
                        <!-- Panel de ayuda -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información de Ayuda</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6>Campos Obligatorios</h6>
                                    <ul class="list-unstyled small">
                                        <li><i class="fas fa-check text-success me-1"></i>Número de contrato</li>
                                        <li><i class="fas fa-check text-success me-1"></i>Cliente/Proveedor</li>
                                        <li><i class="fas fa-check text-success me-1"></i>Título</li>
                                        <li><i class="fas fa-check text-success me-1"></i>Monto original</li>
                                        <li><i class="fas fa-check text-success me-1"></i>Fechas de inicio y fin</li>
                                    </ul>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>Estados de Contrato</h6>
                                    <ul class="list-unstyled small">
                                        <li><span class="badge bg-secondary me-1">Borrador</span> En preparación</li>
                                        <li><span class="badge bg-success me-1">Activo</span> En ejecución</li>
                                    </ul>
                                </div>
                                
                                <div class="alert alert-info small">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    <strong>Consejo:</strong> Selecciona primero el cliente para poder asignar una persona responsable.
                                </div>
                            </div>
                        </div>

                        <!-- Información del cliente seleccionado -->
                        <div class="card mt-3" id="infoClienteModal" style="display: none;">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-building me-2"></i>Información del Cliente</h6>
                            </div>
                            <div class="card-body" id="datosClienteModal">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarContrato">
                    <i class="fas fa-save me-1"></i>Crear Contrato
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript para el modal de crear contrato
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('crearContratoModal');
    
    // Cargar personas responsables cuando se selecciona un cliente
    document.getElementById('cliente_id_modal').addEventListener('change', function() {
        const clienteId = this.value;
        const personaSelect = document.getElementById('persona_responsable_id_modal');
        const infoCliente = document.getElementById('infoClienteModal');
        
        // Limpiar opciones
        personaSelect.innerHTML = '<option value="">Cargando...</option>';
        personaSelect.disabled = true;
        
        if (clienteId) {
            // Cargar personas responsables
            fetch(`/api/clientes/${clienteId}/personas`)
                .then(response => response.json())
                .then(data => {
                    personaSelect.innerHTML = '<option value="">Sin asignar</option>';
                    
                    if (data.success && data.personas) {
                        data.personas.forEach(persona => {
                            const option = document.createElement('option');
                            option.value = persona.id;
                            option.textContent = `${persona.nombre}${persona.cargo ? ' - ' + persona.cargo : ''}${persona.es_principal ? ' (Principal)' : ''}`;
                            if (persona.es_principal) {
                                option.selected = true;
                            }
                            personaSelect.appendChild(option);
                        });
                    }
                    
                    personaSelect.disabled = false;
                })
                .catch(error => {
                    console.error('Error cargando personas:', error);
                    personaSelect.innerHTML = '<option value="">Error cargando datos</option>';
                    personaSelect.disabled = false;
                });
            
            // Mostrar información del cliente
            const clienteOption = this.options[this.selectedIndex];
            const clienteNombre = clienteOption.textContent;
            document.getElementById('datosClienteModal').innerHTML = `
                <p class="mb-1"><strong>Cliente:</strong> ${clienteNombre}</p>
                <p class="mb-0 text-muted small">Personas responsables cargadas</p>
            `;
            infoCliente.style.display = 'block';
        } else {
            personaSelect.innerHTML = '<option value="">Seleccionar cliente primero...</option>';
            personaSelect.disabled = false;
            infoCliente.style.display = 'none';
        }
    });

    // Validación de fechas
    document.getElementById('fecha_inicio_modal').addEventListener('change', function() {
        const fechaInicio = new Date(this.value);
        const fechaFinInput = document.getElementById('fecha_fin_modal');
        
        // Establecer fecha mínima para fecha fin
        fechaFinInput.min = this.value;
        
        // Si la fecha fin es anterior a la fecha inicio, limpiarla
        if (fechaFinInput.value && new Date(fechaFinInput.value) < fechaInicio) {
            fechaFinInput.value = '';
        }
    });

    // Manejar el envío del formulario
    document.getElementById('btnGuardarContrato').addEventListener('click', function() {
        const form = document.getElementById('formContratoModal');
        
        // Validar que el formulario sea válido
        if (!form.checkValidity()) {
            form.reportValidity();
            return false;
        }
        
        // Validaciones adicionales
        const fechaInicio = new Date(document.getElementById('fecha_inicio_modal').value);
        const fechaFin = new Date(document.getElementById('fecha_fin_modal').value);
        
        if (fechaFin <= fechaInicio) {
            alert('La fecha de fin debe ser posterior a la fecha de inicio.');
            return false;
        }
        
        // Validar monto
        const monto = parseFloat(document.getElementById('monto_original_modal').value);
        if (monto <= 0) {
            alert('El monto debe ser mayor a cero.');
            return false;
        }
        
        // Si las validaciones pasan, enviar el formulario
        form.submit();
    });

    // Limpiar formulario cuando se cierra el modal
    modal.addEventListener('hidden.bs.modal', function() {
        document.getElementById('formContratoModal').reset();
        document.getElementById('persona_responsable_id_modal').innerHTML = '<option value="">Seleccionar cliente primero...</option>';
        document.getElementById('infoClienteModal').style.display = 'none';
    });

    // Establecer fecha mínima como hoy cuando se abre el modal
    modal.addEventListener('shown.bs.modal', function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha_inicio_modal').min = today;
    });
});
</script>