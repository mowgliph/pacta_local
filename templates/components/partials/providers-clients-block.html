<!-- 
    Providers and Clients Management Block Component
    =============================================
    
    Parameters:
    - title: Block title (default: "Gestión de Proveedores y Clientes")
    - subtitle: Block subtitle (default: "Información de proveedores y clientes con mayor actividad contractual")
    - providers_title: Providers column title (default: "Proveedores Principales")
    - providers_subtitle: Providers column subtitle (default: "Top proveedores por número de contratos")
    - clients_title: Clients column title (default: "Clientes Principales")
    - clients_subtitle: Clients column subtitle (default: "Top clientes por número de contratos")
    - providers_manage_url: URL for providers management (default: "/proveedores")
    - clients_manage_url: URL for clients management (default: "/clientes")
    - show_manage_buttons: Show management buttons (default: true)
    - providers_api_url: API endpoint for providers data (required)
    - clients_api_url: API endpoint for clients data (required)
    - component_id: Unique ID for the component (required for multiple instances)
-->

{% set title = title or "Gestión de Proveedores y Clientes" %}
{% set subtitle = subtitle or "Información de proveedores y clientes con mayor actividad contractual" %}
{% set providers_title = providers_title or "Proveedores Principales" %}
{% set providers_subtitle = providers_subtitle or "Top proveedores por número de contratos" %}
{% set clients_title = clients_title or "Clientes Principales" %}
{% set clients_subtitle = clients_subtitle or "Top clientes por número de contratos" %}
{% set providers_manage_url = providers_manage_url or "/proveedores/dashboard" %}
{% set clients_manage_url = clients_manage_url or "/clientes" %}
{% set show_manage_buttons = show_manage_buttons if show_manage_buttons is defined else true %}
{% set component_id = component_id or "providers-clients-block" %}

<!-- Component Container -->
<div class="providers-clients-block" 
     id="{{ component_id }}" 
     data-providers-api="{{ providers_api_url }}"
     data-clients-api="{{ clients_api_url }}">
     
    <!-- Block Header -->
    <div class="block-header">
        <div class="block-title-section">
            <h2 class="block-title">
                <span class="block-icon">
                    <i class="fas fa-users"></i>
                </span>
                {{ title }}
            </h2>
            {% if subtitle %}
                <p class="block-subtitle">{{ subtitle }}</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Block Content -->
    <div class="block-content">
        <!-- Loading State -->
        <div id="{{ component_id }}-loading" class="loading-state">
            <div class="loading-spinner"></div>
            <p class="loading-text">Cargando información...</p>
            <p class="loading-subtext">Por favor espere un momento</p>
        </div>
        
        <!-- Error State -->
        <div id="{{ component_id }}-error" class="error-state">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="error-title">Error al cargar la información</h3>
            <p class="error-message">No se pudieron cargar los datos. Por favor, intente nuevamente.</p>
            <button class="btn btn-primary btn-retry">
                <i class="fas fa-redo"></i>
                Reintentar
            </button>
        </div>
        
        <!-- Content -->
        <div id="{{ component_id }}-content" class="providers-clients-content">
            <div class="providers-clients-grid">
                <!-- Providers Column -->
                <div class="card-modern">
                    <div class="card-header-modern">
                        <div class="card-header-content">
                            <div class="card-icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="card-title-wrapper">
                                <h3 class="card-title">{{ providers_title }}</h3>
                                <p class="card-subtitle">{{ providers_subtitle }}</p>
                            </div>
                        </div>
                        {% if show_manage_buttons %}
                        <a href="{{ providers_manage_url }}" class="btn btn-manage btn-primary">
                            <i class="fas fa-cog"></i>
                            Gestionar
                        </a>
                        {% endif %}
                    </div>
                    <div class="card-body-modern">
                        <div id="{{ component_id }}-providers-list" class="items-list">
                            <div class="loading-items">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando proveedores...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Clients Column -->
                <div class="card-modern">
                    <div class="card-header-modern">
                        <div class="card-header-content">
                            <div class="card-icon">
                                <i class="fas fa-handshake"></i>
                            </div>
                            <div class="card-title-wrapper">
                                <h3 class="card-title">{{ clients_title }}</h3>
                                <p class="card-subtitle">{{ clients_subtitle }}</p>
                            </div>
                        </div>
                        {% if show_manage_buttons %}
                        <a href="{{ clients_manage_url }}" class="btn btn-manage btn-success">
                            <i class="fas fa-cog"></i>
                            Gestionar
                        </a>
                        {% endif %}
                    </div>
                    <div class="card-body-modern">
                        <div id="{{ component_id }}-clients-list" class="items-list">
                            <div class="loading-items">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando clientes...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load the component's JavaScript -->
<script src="{{ url_for('static', filename='js/components/providers-clients-block.js') }}"></script>

<!-- Initialize the component -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find all provider-client blocks on the page
        document.querySelectorAll('.providers-clients-block').forEach(block => {
            const componentId = block.id;
            
            // Usar las rutas de la API según las rutas definidas en el backend
            const providersApiUrl = '/api/providers-summary';
            const clientsApiUrl = '/api/clients-summary';
            
            console.log('Configurando URLs de la API:', {
                providers: providersApiUrl,
                clients: clientsApiUrl
            });
            
            console.log('Initializing ProvidersClientsBlock with endpoints:', {
                providers: providersApiUrl,
                clients: clientsApiUrl
            });
            
            if (window.ProvidersClientsBlock) {
                try {
                    // Get the manage URLs from data attributes if they exist
                    const providersManageUrl = block.querySelector('.btn-manage[href*="proveedores"]')?.getAttribute('href') || '/proveedores';
                    const clientsManageUrl = block.querySelector('.btn-manage[href*="clientes"]')?.getAttribute('href') || '/clientes';
                    
                    // Initialize the component
                    const instance = new window.ProvidersClientsBlock(componentId, {
                        providersApiUrl: providersApiUrl,
                        clientsApiUrl: clientsApiUrl,
                        providersManageUrl: providersManageUrl,
                        clientsManageUrl: clientsManageUrl,
                        showProviders: true,
                        showClients: true,
                        maxItems: 5
                    });
                    
                    // Load data
                    instance.loadData();
                    
                    // Set up retry button
                    const retryBtn = block.querySelector('.btn-retry');
                    if (retryBtn) {
                        retryBtn.addEventListener('click', () => instance.loadData());
                    }
                } catch (error) {
                    console.error('Error initializing ProvidersClientsBlock:', error);
                    const errorEl = block.querySelector('.error-state .error-message');
                    if (errorEl) {
                        errorEl.textContent = 'Error al inicializar el componente: ' + error.message;
                    }
                }
            } else {
                console.error('ProvidersClientsBlock component not found. Make sure providers-clients-block.js is loaded.');
            }
        });
    });
</script>