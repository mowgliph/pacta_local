<!-- Providers and Clients Management Block Component -->
<!-- Parameters:
     - title: Block title (default: "Gestión de Proveedores y Clientes")
     - subtitle: Block subtitle (default: "Información de proveedores y clientes con mayor actividad contractual")
     - providers_title: Providers column title (default: "Proveedores Principales")
     - providers_subtitle: Providers column subtitle (default: "Top proveedores por número de contratos")
     - clients_title: Clients column title (default: "Clientes Principales")
     - clients_subtitle: Clients column subtitle (default: "Top clientes por número de contratos")
     - providers_manage_url: URL for providers management (default: "/proveedores")
     - clients_manage_url: URL for clients management (default: "/clientes")
     - show_manage_buttons: Show management buttons (default: true)
     - data_source: API endpoint for data (required)
     - component_id: Unique ID for the component (required for multiple instances)
-->

{% set title = title or "Gestión de Proveedores y Clientes" %}
{% set subtitle = subtitle or "Información de proveedores y clientes con mayor actividad contractual" %}
{% set providers_title = providers_title or "Proveedores Principales" %}
{% set providers_subtitle = providers_subtitle or "Top proveedores por número de contratos" %}
{% set clients_title = clients_title or "Clientes Principales" %}
{% set clients_subtitle = clients_subtitle or "Top clientes por número de contratos" %}
{% set providers_manage_url = providers_manage_url or "/proveedores" %}
{% set clients_manage_url = clients_manage_url or "/clientes" %}
{% set show_manage_buttons = show_manage_buttons if show_manage_buttons is defined else true %}
{% set component_id = component_id or "providers-clients-block" %}

<div class="block-section providers-clients-block" id="{{ component_id }}">
    <div class="block-header">
        <div class="block-title-section">
            <h3 class="block-title">
                <i class="fas fa-users" style="color: #3b82f6; margin-right: 8px;"></i>
                {{ title }}
            </h3>
            <p class="block-subtitle">{{ subtitle }}</p>
        </div>
    </div>
    <div class="block-content">
        <!-- Loading State -->
        <div class="loading-state" id="{{ component_id }}-loading" style="display: flex; justify-content: center; align-items: center; padding: 60px; color: #6b7280;">
            <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
            Cargando información...
        </div>
        
        <!-- Error State -->
        <div class="error-state" id="{{ component_id }}-error" style="display: none; text-align: center; padding: 60px; color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
            <span class="error-message">Error al cargar la información</span>
            <button class="btn btn-sm btn-outline-primary" onclick="window.location.reload()" style="margin-left: 12px;">
                <i class="fas fa-redo"></i> Reintentar
            </button>
        </div>
        
        <!-- Content -->
        <div class="providers-clients-content" id="{{ component_id }}-content" style="display: none;">
            <!-- Two Column Layout -->
            <div class="providers-clients-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                
                <!-- Providers Column -->
                <div class="providers-column" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e1e8ed; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s ease;">
                    <div class="column-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #f1f5f9; position: relative;">
                        <div>
                            <h4 style="font-size: 20px; font-weight: 700; color: #1e293b; margin: 0; display: flex; align-items: center; letter-spacing: -0.025em;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);">
                                    <i class="fas fa-building" style="color: white; font-size: 16px;"></i>
                                </div>
                                {{ providers_title }}
                            </h4>
                            <p style="font-size: 14px; color: #64748b; margin: 8px 0 0 52px; font-weight: 500;">{{ providers_subtitle }}</p>
                        </div>
                        {% if show_manage_buttons %}
                        <button class="btn btn-primary btn-sm d-flex align-items-center gap-2" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 8px rgba(59, 130, 246, 0.3)'" onclick="window.location.href='{{ providers_manage_url }}'">
                            <i class="fas fa-cog"></i>
                            Gestionar Proveedor
                        </button>
                        {% endif %}
                    </div>
                    
                    <div class="providers-list" id="{{ component_id }}-providers-list" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
                
                <!-- Clients Column -->
                <div class="clients-column" style="background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); border: 1px solid #d1fae5; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s ease;">
                    <div class="column-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #ecfdf5; position: relative;">
                        <div>
                            <h4 style="font-size: 20px; font-weight: 700; color: #1e293b; margin: 0; display: flex; align-items: center; letter-spacing: -0.025em;">
                                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981, #047857); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);">
                                    <i class="fas fa-handshake" style="color: white; font-size: 16px;"></i>
                                </div>
                                {{ clients_title }}
                            </h4>
                            <p style="font-size: 14px; color: #64748b; margin: 8px 0 0 52px; font-weight: 500;">{{ clients_subtitle }}</p>
                        </div>
                        {% if show_manage_buttons %}
                        <button class="btn btn-success btn-sm d-flex align-items-center gap-2" style="background: linear-gradient(135deg, #10b981, #047857); border: none; padding: 10px 16px; border-radius: 10px; font-weight: 600; box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.3)'" onclick="window.location.href='{{ clients_manage_url }}'">
                            <i class="fas fa-cog"></i>
                            Gestionar Cliente
                        </button>
                        {% endif %}
                    </div>
                    
                    <div class="clients-list" id="{{ component_id }}-clients-list" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load providers and clients data for this component instance
function loadProvidersClientsData(componentId, providersUrl, clientsUrl) {
    const loadingEl = document.getElementById(componentId + '-loading');
    const errorEl = document.getElementById(componentId + '-error');
    const contentEl = document.getElementById(componentId + '-content');
    
    // Show loading state
    loadingEl.style.display = 'flex';
    errorEl.style.display = 'none';
    contentEl.style.display = 'none';
    
    // Fetch both providers and clients data
     Promise.all([
         fetch(providersUrl).then(response => {
             if (!response.ok) {
                 throw new Error('Providers network response was not ok');
             }
             return response.json();
         }),
         fetch(clientsUrl).then(response => {
             if (!response.ok) {
                 throw new Error('Clients network response was not ok');
             }
             return response.json();
         })
     ])
         .then(([providersResponse, clientsResponse]) => {
             const combinedData = {
                 providers: providersResponse.success ? providersResponse.providers : [],
                 clients: clientsResponse.success ? clientsResponse.clients : []
             };
             renderProvidersClientsData(componentId, combinedData);
            
            // Show content
            loadingEl.style.display = 'none';
            errorEl.style.display = 'none';
            contentEl.style.display = 'block';
        })
        .catch(error => {
            console.error('Error loading providers and clients data:', error);
            
            // Show error state
            loadingEl.style.display = 'none';
            errorEl.style.display = 'block';
            contentEl.style.display = 'none';
        });
}

// Render providers and clients data
function renderProvidersClientsData(componentId, data) {
    const providersListEl = document.getElementById(componentId + '-providers-list');
    const clientsListEl = document.getElementById(componentId + '-clients-list');
    
    // Clear existing content
    providersListEl.innerHTML = '';
    clientsListEl.innerHTML = '';
    
    // Render providers
    if (data.providers && data.providers.length > 0) {
        data.providers.forEach((provider, index) => {
            const providerEl = createProviderClientItem(provider, 'provider', index);
            providersListEl.appendChild(providerEl);
        });
    } else {
        providersListEl.innerHTML = `
            <div style="
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                padding: 40px 20px; 
                background: rgba(248, 250, 252, 0.5); 
                border: 2px dashed #cbd5e1; 
                border-radius: 12px; 
                color: #64748b;
                text-align: center;
            ">
                <div style="
                    width: 48px; 
                    height: 48px; 
                    background: linear-gradient(135deg, #e2e8f0, #cbd5e1); 
                    border-radius: 50%; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    margin-bottom: 12px;
                ">
                    <i class="fas fa-building" style="color: #94a3b8; font-size: 20px;"></i>
                </div>
                <p style="font-size: 14px; font-weight: 600; margin: 0 0 4px 0;">No hay proveedores disponibles</p>
                <p style="font-size: 12px; margin: 0; opacity: 0.8;">Los proveedores aparecerán aquí cuando se registren</p>
            </div>
        `;
    }
    
    // Render clients
    if (data.clients && data.clients.length > 0) {
        data.clients.forEach((client, index) => {
            const clientEl = createProviderClientItem(client, 'client', index);
            clientsListEl.appendChild(clientEl);
        });
    } else {
        clientsListEl.innerHTML = `
            <div style="
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                padding: 40px 20px; 
                background: rgba(240, 253, 244, 0.5); 
                border: 2px dashed #a7f3d0; 
                border-radius: 12px; 
                color: #64748b;
                text-align: center;
            ">
                <div style="
                    width: 48px; 
                    height: 48px; 
                    background: linear-gradient(135deg, #d1fae5, #a7f3d0); 
                    border-radius: 50%; 
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    margin-bottom: 12px;
                ">
                    <i class="fas fa-handshake" style="color: #6ee7b7; font-size: 20px;"></i>
                </div>
                <p style="font-size: 14px; font-weight: 600; margin: 0 0 4px 0;">No hay clientes disponibles</p>
                <p style="font-size: 12px; margin: 0; opacity: 0.8;">Los clientes aparecerán aquí cuando se registren</p>
            </div>
        `;
    }
}

// Create provider or client item element
function createProviderClientItem(item, type, index) {
    const colors = {
        provider: ['#3b82f6', '#1d4ed8', '#10b981', '#047857', '#f59e0b', '#d97706'],
        client: ['#10b981', '#047857', '#3b82f6', '#1d4ed8', '#8b5cf6', '#7c3aed']
    };
    
    const color = colors[type][index % colors[type].length];
    
    const div = document.createElement('div');
    div.className = type + '-item';
    div.style.cssText = `
        display: flex; 
        align-items: center; 
        padding: 16px 20px; 
        background: rgba(255, 255, 255, 0.8); 
        border: 1px solid rgba(226, 232, 240, 0.8); 
        border-radius: 12px; 
        margin-bottom: 2px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    `;
    
    // Add hover effects
    div.addEventListener('mouseenter', function() {
        this.style.transform = 'translateX(8px)';
        this.style.background = 'rgba(255, 255, 255, 0.95)';
        this.style.borderColor = color;
        this.style.boxShadow = `0 8px 25px rgba(0, 0, 0, 0.1), 0 0 0 1px ${color}20`;
    });
    
    div.addEventListener('mouseleave', function() {
        this.style.transform = 'translateX(0px)';
        this.style.background = 'rgba(255, 255, 255, 0.8)';
        this.style.borderColor = 'rgba(226, 232, 240, 0.8)';
        this.style.boxShadow = 'none';
    });
    
    // Generate initials from name
    const initials = item.nombre ? item.nombre.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase() : '??';
    
    div.innerHTML = `
        <div class="${type}-status-indicator" style="position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: linear-gradient(180deg, ${color}, ${color}aa); border-radius: 0 4px 4px 0;"></div>
        <div class="${type}-avatar" style="width: 44px; height: 44px; background: linear-gradient(135deg, ${color}, ${color}dd); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 15px; margin-right: 16px; box-shadow: 0 4px 12px ${color}30; flex-shrink: 0;">
            ${initials}
        </div>
        <div class="${type}-details" style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                <h5 style="font-size: 15px; font-weight: 600; color: #1e293b; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">${item.nombre || 'Sin nombre'}</h5>
                <div class="${type}-actions" style="display: flex; gap: 6px; opacity: 0.7; transition: opacity 0.3s ease;">
                    <button class="btn-icon" style="width: 28px; height: 28px; background: ${color}15; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;" title="Ver detalles" onclick="view${type.charAt(0).toUpperCase() + type.slice(1)}Details(${item.id})" onmouseover="this.style.background='${color}25'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='${color}15'; this.style.transform='scale(1)'">
                        <i class="fas fa-eye" style="color: ${color}; font-size: 12px;"></i>
                    </button>
                    <button class="btn-icon" style="width: 28px; height: 28px; background: ${color}15; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;" title="Más opciones" onmouseover="this.style.background='${color}25'; this.style.transform='scale(1.1)'" onmouseout="this.style.background='${color}15'; this.style.transform='scale(1)'">
                        <i class="fas fa-ellipsis-h" style="color: ${color}; font-size: 12px;"></i>
                    </button>
                </div>
            </div>
            <p style="font-size: 12px; color: #64748b; margin: 0 0 8px 0; font-weight: 500;">${item.industria || item.sector || 'Sin categoría'}</p>
            <div style="display: flex; gap: 20px; font-size: 11px;">
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 6px; height: 6px; background: #3b82f6; border-radius: 50%;"></div>
                    <span style="color: #475569; font-weight: 600;">${item.contratos_count || 0} Contratos</span>
                </div>
                <div style="display: flex; align-items: center; gap: 4px;">
                    <div style="width: 6px; height: 6px; background: #10b981; border-radius: 50%;"></div>
                    <span style="color: #475569; font-weight: 600;">$${formatCurrency(item.total_value || 0)}</span>
                </div>
            </div>
        </div>
    `;
    
    // Add hover effect for actions
    div.addEventListener('mouseenter', function() {
        const actions = this.querySelector(`.${type}-actions`);
        if (actions) actions.style.opacity = '1';
    });
    
    div.addEventListener('mouseleave', function() {
        const actions = this.querySelector(`.${type}-actions`);
        if (actions) actions.style.opacity = '0.7';
    });
    
    return div;
}

// Format currency helper
function formatCurrency(amount) {
    return new Intl.NumberFormat('es-MX', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(amount);
}

// Placeholder functions for viewing details (to be implemented by each page)
function viewProviderDetails(id) {
    console.log('View provider details:', id);
    // This function should be implemented by the page using this component
}

function viewClientDetails(id) {
    console.log('View client details:', id);
    // This function should be implemented by the page using this component
}

// Auto-initialize the component when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // This component will be initialized by the main providers-clients-block.js script
    // which looks for elements with data-providers-clients-block attribute
});
</script>